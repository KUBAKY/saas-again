# 电话销售管理系统项目开发指导

## 一、项目架构与技术栈

### 1.1 整体架构
```
前端 (React + TypeScript + Ant Design)
    ↓ HTTP/HTTPS
后端 (Node.js + Express + TypeScript)
    ↓ ORM
数据库 (MySQL 8.0)
```

### 1.2 目录结构
```
tscrm/
├── frontend/                 # 前端项目
│   ├── src/
│   │   ├── components/       # 通用组件
│   │   ├── pages/           # 页面组件
│   │   ├── services/        # API服务
│   │   ├── types/           # TypeScript类型定义
│   │   ├── utils/           # 工具函数
│   │   ├── store/           # Redux状态管理
│   │   └── hooks/           # 自定义Hooks
│   ├── public/
│   └── package.json
├── backend/                  # 后端项目
│   ├── src/
│   │   ├── controllers/     # 控制器
│   │   ├── services/        # 业务逻辑
│   │   ├── models/          # 数据模型
│   │   ├── middleware/      # 中间件
│   │   ├── routes/          # 路由
│   │   ├── utils/           # 工具函数
│   │   └── types/           # 类型定义
│   ├── database/
│   │   ├── migrations/      # 数据库迁移
│   │   └── seeds/           # 初始数据
│   └── package.json
├── docs/                     # 文档
└── deploy/                   # 部署配置
```

### 1.3 技术栈详细配置

#### 前端技术栈
- **React 18** + **TypeScript 4.9+**
- **Ant Design 5.x** - UI组件库
- **Redux Toolkit** + **RTK Query** - 状态管理和数据获取
- **React Router 6** - 路由管理
- **Axios** - HTTP客户端
- **dayjs** - 日期处理
- **ahooks** - React Hooks库

#### 后端技术栈
- **Node.js 18+** + **TypeScript 4.9+**
- **Express.js** - Web框架
- **TypeORM** - ORM框架
- **MySQL 8.0** - 数据库
- **JWT** + **bcrypt** - 认证加密
- **multer** - 文件上传
- **xlsx** + **csv-parser** - Excel/CSV处理
- **joi** - 数据验证
- **winston** - 日志管理

---

## 二、数据库设计与实现

### 2.1 数据库建表SQL
```sql
-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    phone VARCHAR(11) UNIQUE NOT NULL COMMENT '手机号',
    password VARCHAR(255) NOT NULL COMMENT '密码',
    name VARCHAR(50) NOT NULL COMMENT '姓名',
    role ENUM('manager', 'leader', 'sales') NOT NULL COMMENT '角色',
    team_id INT NULL COMMENT '所属小组ID',
    join_date DATE NOT NULL COMMENT '入职时间',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_phone (phone),
    INDEX idx_team_id (team_id),
    INDEX idx_role (role)
);

-- 小组表
CREATE TABLE teams (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '小组名称',
    level ENUM('4', '10', '15', '30') NOT NULL COMMENT '小组等级',
    leader_id INT NULL COMMENT '组长ID',
    member_count INT DEFAULT 0 COMMENT '当前成员数量',
    max_members INT NOT NULL COMMENT '最大成员数量',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_leader_id (leader_id)
);

-- 客户表
CREATE TABLE customers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    star_level TINYINT NOT NULL COMMENT '价值星级1-5',
    name VARCHAR(50) NOT NULL COMMENT '客户姓名',
    phone VARCHAR(20) NOT NULL COMMENT '客户电话',
    gender ENUM('male', 'female') NULL COMMENT '性别',
    age TINYINT NULL COMMENT '年龄',
    qualification TEXT NULL COMMENT '客户资质',
    owner_id INT NOT NULL COMMENT '归属销售员ID',
    team_id INT NOT NULL COMMENT '归属小组ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_phone (phone),
    INDEX idx_owner_id (owner_id),
    INDEX idx_team_id (team_id),
    INDEX idx_star_level (star_level)
);

-- 跟进记录表
CREATE TABLE follow_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL COMMENT '客户ID',
    sales_id INT NOT NULL COMMENT '跟进销售员ID',
    content TEXT NOT NULL COMMENT '跟进内容',
    follow_time TIMESTAMP NOT NULL COMMENT '跟进时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_customer_id (customer_id),
    INDEX idx_sales_id (sales_id),
    INDEX idx_follow_time (follow_time),
    INDEX idx_customer_follow_time (customer_id, follow_time)
);

-- 操作日志表
CREATE TABLE operation_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT '操作用户ID',
    action VARCHAR(50) NOT NULL COMMENT '操作类型',
    target_type VARCHAR(20) NOT NULL COMMENT '目标类型',
    target_id INT NOT NULL COMMENT '目标ID',
    details JSON NULL COMMENT '操作详情',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
);

-- 外键约束
ALTER TABLE users ADD CONSTRAINT fk_users_team_id FOREIGN KEY (team_id) REFERENCES teams(id);
ALTER TABLE teams ADD CONSTRAINT fk_teams_leader_id FOREIGN KEY (leader_id) REFERENCES users(id);
ALTER TABLE customers ADD CONSTRAINT fk_customers_owner_id FOREIGN KEY (owner_id) REFERENCES users(id);
ALTER TABLE customers ADD CONSTRAINT fk_customers_team_id FOREIGN KEY (team_id) REFERENCES teams(id);
ALTER TABLE follow_records ADD CONSTRAINT fk_follow_records_customer_id FOREIGN KEY (customer_id) REFERENCES customers(id);
ALTER TABLE follow_records ADD CONSTRAINT fk_follow_records_sales_id FOREIGN KEY (sales_id) REFERENCES users(id);
ALTER TABLE operation_logs ADD CONSTRAINT fk_operation_logs_user_id FOREIGN KEY (user_id) REFERENCES users(id);
```

### 2.2 初始数据插入
```sql
-- 插入默认管理员账号
INSERT INTO users (phone, password, name, role, join_date) VALUES 
('13800000000', '$2b$12$encrypted_password_hash', '系统管理员', 'manager', CURDATE());
```

---

## 三、后端开发实现

### 3.1 项目初始化
```bash
# 创建后端项目
mkdir backend && cd backend
npm init -y

# 安装依赖
npm install express typescript ts-node @types/node @types/express
npm install typeorm mysql2 reflect-metadata
npm install jsonwebtoken bcrypt @types/jsonwebtoken @types/bcrypt
npm install joi multer xlsx csv-parser @types/multer
npm install winston cors helmet compression
npm install --save-dev nodemon @types/cors @types/helmet
```

### 3.2 TypeORM配置
```typescript
// src/config/database.ts
import { DataSource } from 'typeorm';
import { User } from '../models/User';
import { Team } from '../models/Team';
import { Customer } from '../models/Customer';
import { FollowRecord } from '../models/FollowRecord';
import { OperationLog } from '../models/OperationLog';

export const AppDataSource = new DataSource({
  type: 'mysql',
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '3306'),
  username: process.env.DB_USERNAME || 'root',
  password: process.env.DB_PASSWORD || '',
  database: process.env.DB_DATABASE || 'tscrm',
  synchronize: process.env.NODE_ENV === 'development',
  logging: process.env.NODE_ENV === 'development',
  entities: [User, Team, Customer, FollowRecord, OperationLog],
  migrations: ['src/database/migrations/*.ts'],
  subscribers: ['src/database/subscribers/*.ts'],
});
```

### 3.3 实体模型定义
```typescript
// src/models/User.ts
import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, OneToMany, JoinColumn } from 'typeorm';
import { Team } from './Team';
import { Customer } from './Customer';
import { FollowRecord } from './FollowRecord';

@Entity('users')
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ unique: true, length: 11 })
  phone: string;

  @Column()
  password: string;

  @Column({ length: 50 })
  name: string;

  @Column({ type: 'enum', enum: ['manager', 'leader', 'sales'] })
  role: 'manager' | 'leader' | 'sales';

  @Column({ name: 'team_id', nullable: true })
  teamId: number;

  @Column({ name: 'join_date', type: 'date' })
  joinDate: Date;

  @Column({ type: 'enum', enum: ['active', 'inactive'], default: 'active' })
  status: 'active' | 'inactive';

  @Column({ name: 'created_at', type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @Column({ name: 'updated_at', type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  @Column({ name: 'deleted_at', type: 'timestamp', nullable: true })
  deletedAt: Date;

  @ManyToOne(() => Team, team => team.members)
  @JoinColumn({ name: 'team_id' })
  team: Team;

  @OneToMany(() => Customer, customer => customer.owner)
  customers: Customer[];

  @OneToMany(() => FollowRecord, record => record.sales)
  followRecords: FollowRecord[];
}
```

### 3.4 权限中间件
```typescript
// src/middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import { AppDataSource } from '../config/database';
import { User } from '../models/User';

export interface AuthRequest extends Request {
  user?: User;
}

export const authenticateToken = async (req: AuthRequest, res: Response, next: NextFunction) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ code: 401, message: '未提供访问令牌' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
    const userRepository = AppDataSource.getRepository(User);
    const user = await userRepository.findOne({ 
      where: { id: decoded.userId, status: 'active' },
      relations: ['team']
    });

    if (!user) {
      return res.status(401).json({ code: 401, message: '无效的访问令牌' });
    }

    req.user = user;
    next();
  } catch (error) {
    return res.status(403).json({ code: 403, message: '访问令牌已过期' });
  }
};

export const requireRole = (roles: string[]) => {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user || !roles.includes(req.user.role)) {
      return res.status(403).json({ code: 403, message: '权限不足' });
    }
    next();
  };
};
```

### 3.5 客户管理控制器
```typescript
// src/controllers/CustomerController.ts
import { Request, Response } from 'express';
import { AppDataSource } from '../config/database';
import { Customer } from '../models/Customer';
import { AuthRequest } from '../middleware/auth';
import { validateCustomer } from '../validators/customerValidator';

export class CustomerController {
  private customerRepository = AppDataSource.getRepository(Customer);

  // 获取客户列表
  async getCustomers(req: AuthRequest, res: Response) {
    try {
      const { page = 1, pageSize = 20, search, teamId, starLevel } = req.query;
      const user = req.user!;

      let whereCondition: any = { deletedAt: null };

      // 根据角色过滤数据
      if (user.role === 'sales') {
        whereCondition.ownerId = user.id;
      } else if (user.role === 'leader') {
        whereCondition.teamId = user.teamId;
      }

      // 添加筛选条件
      if (search) {
        whereCondition = [
          { ...whereCondition, name: Like(`%${search}%`) },
          { ...whereCondition, phone: Like(`%${search}%`) }
        ];
      }

      if (teamId) whereCondition.teamId = teamId;
      if (starLevel) whereCondition.starLevel = starLevel;

      const [customers, total] = await this.customerRepository.findAndCount({
        where: whereCondition,
        relations: ['owner', 'team'],
        order: { updatedAt: 'DESC' },
        skip: (Number(page) - 1) * Number(pageSize),
        take: Number(pageSize)
      });

      res.json({
        code: 200,
        message: 'success',
        data: {
          list: customers,
          pagination: {
            current: Number(page),
            pageSize: Number(pageSize),
            total
          }
        }
      });
    } catch (error) {
      res.status(500).json({ code: 500, message: '服务器错误' });
    }
  }

  // 创建客户
  async createCustomer(req: AuthRequest, res: Response) {
    try {
      const { error, value } = validateCustomer(req.body);
      if (error) {
        return res.status(400).json({ code: 400, message: error.details[0].message });
      }

      const user = req.user!;
      const customerData = {
        ...value,
        ownerId: user.role === 'manager' ? value.ownerId : user.id,
        teamId: user.role === 'manager' ? value.teamId : user.teamId
      };

      const customer = this.customerRepository.create(customerData);
      await this.customerRepository.save(customer);

      res.json({ code: 200, message: '客户创建成功', data: customer });
    } catch (error) {
      res.status(500).json({ code: 500, message: '服务器错误' });
    }
  }

  // 批量转移客户
  async transferCustomers(req: AuthRequest, res: Response) {
    try {
      const { customerIds, targetOwnerId, targetTeamId } = req.body;
      const user = req.user!;

      if (user.role === 'sales') {
        return res.status(403).json({ code: 403, message: '权限不足' });
      }

      await this.customerRepository.update(
        { id: In(customerIds) },
        { ownerId: targetOwnerId, teamId: targetTeamId }
      );

      res.json({ code: 200, message: '客户转移成功' });
    } catch (error) {
      res.status(500).json({ code: 500, message: '服务器错误' });
    }
  }
}
```

---

## 四、前端开发实现

### 4.1 项目初始化
```bash
# 使用Create React App创建项目
npx create-react-app frontend --template typescript
cd frontend

# 安装依赖
npm install antd @reduxjs/toolkit react-redux react-router-dom
npm install axios dayjs ahooks
npm install @types/node
```

### 4.2 Redux Store配置
```typescript
// src/store/index.ts
import { configureStore } from '@reduxjs/toolkit';
import { authApi } from './api/authApi';
import { customerApi } from './api/customerApi';
import authSlice from './slices/authSlice';

export const store = configureStore({
  reducer: {
    auth: authSlice,
    [authApi.reducerPath]: authApi.reducer,
    [customerApi.reducerPath]: customerApi.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(
      authApi.middleware,
      customerApi.middleware
    ),
});

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

### 4.3 API服务定义
```typescript
// src/store/api/customerApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';
import { Customer, CustomerListResponse } from '../../types/customer';

export const customerApi = createApi({
  reducerPath: 'customerApi',
  baseQuery: fetchBaseQuery({
    baseUrl: '/api/customers',
    prepareHeaders: (headers, { getState }) => {
      const token = (getState() as any).auth.token;
      if (token) {
        headers.set('authorization', `Bearer ${token}`);
      }
      return headers;
    },
  }),
  tagTypes: ['Customer'],
  endpoints: (builder) => ({
    getCustomers: builder.query<CustomerListResponse, {
      page?: number;
      pageSize?: number;
      search?: string;
      teamId?: number;
      starLevel?: number;
    }>({
      query: (params) => ({
        url: '',
        params,
      }),
      providesTags: ['Customer'],
    }),
    createCustomer: builder.mutation<Customer, Partial<Customer>>({
      query: (customer) => ({
        url: '',
        method: 'POST',
        body: customer,
      }),
      invalidatesTags: ['Customer'],
    }),
    updateCustomer: builder.mutation<Customer, { id: number; data: Partial<Customer> }>({
      query: ({ id, data }) => ({
        url: `/${id}`,
        method: 'PUT',
        body: data,
      }),
      invalidatesTags: ['Customer'],
    }),
    transferCustomers: builder.mutation<void, {
      customerIds: number[];
      targetOwnerId: number;
      targetTeamId: number;
    }>({
      query: (data) => ({
        url: '/transfer',
        method: 'POST',
        body: data,
      }),
      invalidatesTags: ['Customer'],
    }),
  }),
});

export const {
  useGetCustomersQuery,
  useCreateCustomerMutation,
  useUpdateCustomerMutation,
  useTransferCustomersMutation,
} = customerApi;
```

### 4.4 客户列表组件
```typescript
// src/pages/CustomerList.tsx
import React, { useState } from 'react';
import { Table, Button, Input, Select, Space, Tag, Modal, message } from 'antd';
import { PlusOutlined, SearchOutlined } from '@ant-design/icons';
import { useGetCustomersQuery, useTransferCustomersMutation } from '../store/api/customerApi';
import { Customer } from '../types/customer';
import CustomerForm from '../components/CustomerForm';
import TransferModal from '../components/TransferModal';

const CustomerList: React.FC = () => {
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(20);
  const [search, setSearch] = useState('');
  const [selectedRowKeys, setSelectedRowKeys] = useState<number[]>([]);
  const [isCreateModalVisible, setIsCreateModalVisible] = useState(false);
  const [isTransferModalVisible, setIsTransferModalVisible] = useState(false);

  const { data, isLoading, refetch } = useGetCustomersQuery({
    page,
    pageSize,
    search,
  });

  const [transferCustomers] = useTransferCustomersMutation();

  // 获取跟进状态颜色
  const getFollowStatusColor = (customer: Customer) => {
    const today = new Date().toDateString();
    const todayRecords = customer.followRecords?.filter(
      record => new Date(record.followTime).toDateString() === today
    ) || [];

    if (todayRecords.length === 0) return '#ff4d4f'; // 红色
    
    const count = todayRecords.length;
    const colors = ['#e6f7ff', '#b7eb8f', '#73d13d', '#52c41a', '#389e0d'];
    return colors[Math.min(count - 1, 4)];
  };

  const columns = [
    {
      title: '状态',
      dataIndex: 'status',
      width: 60,
      render: (_: any, record: Customer) => (
        <div
          style={{
            width: 20,
            height: 20,
            backgroundColor: getFollowStatusColor(record),
            borderRadius: 4,
          }}
        />
      ),
    },
    {
      title: '星级',
      dataIndex: 'starLevel',
      width: 80,
      render: (level: number) => '★'.repeat(level),
    },
    {
      title: '姓名',
      dataIndex: 'name',
      width: 120,
    },
    {
      title: '电话',
      dataIndex: 'phone',
      width: 140,
    },
    {
      title: '性别',
      dataIndex: 'gender',
      width: 80,
      render: (gender: string) => gender === 'male' ? '男' : '女',
    },
    {
      title: '年龄',
      dataIndex: 'age',
      width: 80,
    },
    {
      title: '资质',
      dataIndex: 'qualification',
      ellipsis: true,
    },
    {
      title: '归属销售员',
      dataIndex: ['owner', 'name'],
      width: 120,
    },
    {
      title: '归属小组',
      dataIndex: ['team', 'name'],
      width: 120,
    },
    {
      title: '最新跟进',
      dataIndex: 'lastFollowTime',
      width: 160,
      render: (time: string) => time ? new Date(time).toLocaleString() : '-',
    },
    {
      title: '操作',
      width: 120,
      render: (_: any, record: Customer) => (
        <Space>
          <Button type="link" size="small">编辑</Button>
          <Button type="link" size="small">详情</Button>
        </Space>
      ),
    },
  ];

  const handleTransfer = async (targetOwnerId: number, targetTeamId: number) => {
    try {
      await transferCustomers({
        customerIds: selectedRowKeys,
        targetOwnerId,
        targetTeamId,
      }).unwrap();
      message.success('客户转移成功');
      setSelectedRowKeys([]);
      setIsTransferModalVisible(false);
      refetch();
    } catch (error) {
      message.error('客户转移失败');
    }
  };

  return (
    <div>
      <div style={{ marginBottom: 16 }}>
        <Space>
          <Input
            placeholder="搜索客户姓名或电话"
            prefix={<SearchOutlined />}
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            style={{ width: 300 }}
          />
          <Button type="primary" icon={<PlusOutlined />} onClick={() => setIsCreateModalVisible(true)}>
            新增客户
          </Button>
          {selectedRowKeys.length > 0 && (
            <Button onClick={() => setIsTransferModalVisible(true)}>
              批量转移 ({selectedRowKeys.length})
            </Button>
          )}
        </Space>
      </div>

      <Table
        columns={columns}
        dataSource={data?.list}
        loading={isLoading}
        rowKey="id"
        rowSelection={{
          selectedRowKeys,
          onChange: setSelectedRowKeys,
        }}
        pagination={{
          current: page,
          pageSize,
          total: data?.pagination.total,
          onChange: (newPage, newPageSize) => {
            setPage(newPage);
            setPageSize(newPageSize || 20);
          },
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total) => `共 ${total} 条记录`,
        }}
      />

      <CustomerForm
        visible={isCreateModalVisible}
        onCancel={() => setIsCreateModalVisible(false)}
        onSuccess={() => {
          setIsCreateModalVisible(false);
          refetch();
        }}
      />

      <TransferModal
        visible={isTransferModalVisible}
        onCancel={() => setIsTransferModalVisible(false)}
        onConfirm={handleTransfer}
        customerCount={selectedRowKeys.length}
      />
    </div>
  );
};

export default CustomerList;
```

---

## 五、关键功能实现

### 5.1 跟进状态色块实现
```typescript
// src/utils/followStatus.ts
export const getFollowStatusColor = (followRecords: FollowRecord[]): string => {
  const today = new Date().toDateString();
  const todayRecords = followRecords.filter(
    record => new Date(record.followTime).toDateString() === today
  );

  if (todayRecords.length === 0) {
    return '#ff4d4f'; // 红色 - 当天无跟进
  }

  // 根据跟进次数返回不同深度的绿色
  const count = Math.min(todayRecords.length, 5);
  const colors = [
    '#e6f7ff', // 1次 - 浅绿
    '#b7eb8f', // 2次 - 淡绿
    '#73d13d', // 3次 - 中绿
    '#52c41a', // 4次 - 深绿
    '#389e0d'  // 5次及以上 - 最深绿
  ];
  
  return colors[count - 1];
};
```

### 5.2 Excel导入导出功能
```typescript
// src/services/excelService.ts
import * as XLSX from 'xlsx';
import { Customer } from '../types/customer';

export class ExcelService {
  // 导出客户数据
  static exportCustomers(customers: Customer[], includeFollowRecords = false): void {
    const data = customers.map(customer => ({
      '客户星级': customer.starLevel,
      '客户姓名': customer.name,
      '客户电话': customer.phone,
      '性别': customer.gender === 'male' ? '男' : '女',
      '年龄': customer.age,
      '客户资质': customer.qualification,
      '归属销售员': customer.owner?.name,
      '归属小组': customer.team?.name,
      '创建时间': new Date(customer.createdAt).toLocaleString(),
      '最新跟进': customer.lastFollowTime ? new Date(customer.lastFollowTime).toLocaleString() : '',
    }));

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '客户数据');

    const fileName = `客户数据_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(workbook, fileName);
  }

  // 解析导入的Excel文件
  static parseImportFile(file: File): Promise<any[]> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target?.result as ArrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          resolve(jsonData);
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // 下载导入模板
  static downloadTemplate(): void {
    const templateData = [
      {
        '客户星级': '1-5',
        '客户姓名': '必填',
        '客户电话': '必填',
        '性别': '男/女',
        '年龄': '数字',
        '客户资质': '可选',
        '归属销售员手机号': '可选',
        '归属小组名称': '可选',
      }
    ];

    const worksheet = XLSX.utils.json_to_sheet(templateData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '导入模板');

    XLSX.writeFile(workbook, '客户数据导入模板.xlsx');
  }
}
```

### 5.3 权限路由守卫
```typescript
// src/components/ProtectedRoute.tsx
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useSelector } from 'react-redux';
import { RootState } from '../store';

interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredRoles?: string[];
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ children, requiredRoles }) => {
  const { user, isAuthenticated } = useSelector((state: RootState) => state.auth);

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  if (requiredRoles && !requiredRoles.includes(user?.role || '')) {
    return <Navigate to="/unauthorized" replace />;
  }

  return <>{children}</>;
};

export default ProtectedRoute;
```

---

## 六、部署配置

### 6.1 Docker配置
```dockerfile
# backend/Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3001

CMD ["npm", "start"]
```

```dockerfile
# frontend/Dockerfile
FROM node:18-alpine as build

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 6.2 Docker Compose配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: tscrm
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: root
      DB_PASSWORD: rootpassword
      DB_DATABASE: tscrm
      JWT_SECRET: your_jwt_secret
    depends_on:
      - mysql

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

---

## 七、开发流程与规范

### 7.1 Git工作流
```bash
# 功能开发流程
git checkout -b feature/customer-management
# 开发功能...
git add .
git commit -m "feat: 实现客户管理功能"
git push origin feature/customer-management
# 创建Pull Request进行代码评审
```

### 7.2 代码规范
- 使用ESLint + Prettier进行代码格式化
- 遵循TypeScript严格模式
- 组件命名使用PascalCase
- 函数命名使用camelCase
- 常量命名使用UPPER_SNAKE_CASE

### 7.3 测试策略
```typescript
// 单元测试示例
// src/__tests__/CustomerService.test.ts
import { CustomerService } from '../services/CustomerService';

describe('CustomerService', () => {
  test('should create customer successfully', async () => {
    const customerData = {
      name: '测试客户',
      phone: '13800000001',
      starLevel: 3,
    };

    const result = await CustomerService.createCustomer(customerData);
    expect(result.name).toBe('测试客户');
  });
});
```

---

## 八、性能优化建议

### 8.1 前端优化
- 使用React.memo优化组件渲染
- 实现虚拟滚动处理大量数据
- 使用懒加载减少初始包大小
- 合理使用缓存策略

### 8.2 后端优化
- 数据库查询优化，添加合适索引
- 实现分页查询减少数据传输
- 使用Redis缓存热点数据
- API响应压缩

### 8.3 数据库优化
- 定期分析慢查询日志
- 合理设计索引策略
- 实现读写分离
- 定期数据备份

---

## 九、上线检查清单

- [ ] 数据库表结构创建完成
- [ ] 初始管理员账号创建
- [ ] 所有API接口测试通过
- [ ] 前端页面功能验证完成
- [ ] 权限控制测试通过
- [ ] 性能测试达标
- [ ] 安全测试通过
- [ ] 部署脚本准备完成
- [ ] 监控告警配置完成
- [ ] 用户使用文档准备完成

---

这份开发指导文档提供了完整的技术实现方案，开发团队可以按照此文档进行高效的项目开发。如需要更详细的某个模块实现，可以进一步补充。
