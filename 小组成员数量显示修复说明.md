# 小组成员数量显示修复说明

## 问题描述

小组管理页面的成员数量显示存在数据不一致问题：
- 数据库中的 `member_count` 字段与实际成员数量不匹配
- 前端显示的总成员数量与销售员数量和组长数量之和不符

## 问题原因

数据库中的 `teams` 表的 `member_count` 字段没有与实际用户数据保持同步，导致：

1. **华东销售组7091**: 记录显示4人，实际有8人（7销售员 + 1组长）
2. **华南销售组8812**: 记录显示3人，实际有2人（1销售员 + 1组长）  
3. **测试小组**: 记录显示6人，实际有5人（4销售员 + 1组长）

## 修复方案

### 1. 创建数据修复脚本

创建了 `fix-team-member-count.js` 脚本来：
- 重新计算每个团队的实际成员数量
- 更新数据库中的 `member_count` 字段
- 验证修复结果

### 2. 修复过程

```bash
node fix-team-member-count.js
```

修复结果：
- ✅ 华东销售组7091: 4 → 8 人
- ✅ 华南销售组8812: 3 → 2 人  
- ✅ 测试小组: 6 → 5 人

### 3. 验证修复效果

修复后的数据验证：

| 团队名称 | 记录数量 | 实际数量 | 销售员 | 组长 | 状态 |
|---------|---------|---------|--------|------|------|
| 华东销售组7091 | 8 | 8 | 7 | 1 | ✅ 正确 |
| 华南销售组8812 | 2 | 2 | 1 | 1 | ✅ 正确 |
| 测试小组 | 5 | 5 | 4 | 1 | ✅ 正确 |

## 技术细节

### 数据库查询逻辑

后端API已经正确实现了实时计算：

```sql
SELECT 
  t.member_count as memberCount,
  (SELECT COUNT(*) FROM users WHERE team_id = t.id AND deleted_at IS NULL AND role = 'sales') as salesCount,
  (SELECT COUNT(*) FROM users WHERE team_id = t.id AND deleted_at IS NULL AND role = 'leader') as leaderCount
FROM teams t
```

### 前端显示逻辑

前端正确显示了：
- 销售员数量/最大限制
- 总成员数量（包含组长）
- 进度条显示销售员占用情况

## 预防措施

为避免类似问题再次发生，建议：

1. **数据一致性检查**: 定期运行修复脚本验证数据一致性
2. **事务处理**: 在添加/移除团队成员时使用事务确保数据一致性
3. **实时计算**: 考虑将 `member_count` 改为计算字段而非存储字段

## 相关文件

- `fix-team-member-count.js` - 数据修复脚本
- `backend/src/routes/teams-sqlite.js` - 团队API实现
- `frontend/src/pages/TeamManagement.tsx` - 前端团队管理页面

## 修复时间

2025-06-05 修复完成 