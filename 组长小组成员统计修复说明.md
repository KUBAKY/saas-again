# 组长小组成员统计修复说明

## 问题描述

组长账号登录后的小组统计页面中，小组成员统计模块只显示销售员数据，没有包含组长在内的所有成员数据。

## 问题原因

1. **后端API查询限制**: 在 `backend/src/routes/statistics-sqlite.js` 中，用户统计查询添加了 `u.role = 'sales'` 的条件，导致只返回销售员数据，排除了组长。

2. **缺少角色字段**: API返回的用户统计数据中缺少 `userRole` 字段，前端无法区分组长和销售员。

3. **前端显示不完整**: 前端表格列定义中没有显示用户角色信息。

## 修复方案

### 1. 后端API修复

**文件**: `backend/src/routes/statistics-sqlite.js`

**修改内容**:
- 移除了 `u.role = 'sales'` 的限制条件
- 在SELECT查询中添加了 `u.role as userRole` 字段
- 更新了权限控制逻辑，确保组长可以查看本小组所有成员（包括自己）

**修改前**:
```sql
SELECT 
  u.id as userId,
  u.name as userName,
  t.name as teamName,
  COUNT(DISTINCT c.id) as customerCount,
  COUNT(DISTINCT fr.id) as followCount
FROM users u
LEFT JOIN teams t ON u.team_id = t.id
LEFT JOIN customers c ON u.id = c.owner_id AND c.deleted_at IS NULL
LEFT JOIN follow_records fr ON c.id = fr.customer_id
WHERE u.deleted_at IS NULL AND u.role = 'sales'
```

**修改后**:
```sql
SELECT 
  u.id as userId,
  u.name as userName,
  u.role as userRole,
  t.name as teamName,
  COUNT(DISTINCT c.id) as customerCount,
  COUNT(DISTINCT fr.id) as followCount
FROM users u
LEFT JOIN teams t ON u.team_id = t.id
LEFT JOIN customers c ON u.id = c.owner_id AND c.deleted_at IS NULL
LEFT JOIN follow_records fr ON c.id = fr.customer_id
WHERE u.deleted_at IS NULL
```

### 2. 前端类型定义更新

**文件**: `frontend/src/types/index.ts`

**修改内容**:
- 在 `UserStatistics` 接口中添加了 `userRole: UserRole` 字段

### 3. 前端显示优化

**文件**: `frontend/src/pages/Statistics.tsx`

**修改内容**:
- 更新了用户统计表格的第一列标题，根据用户角色显示"成员姓名"或"销售员"
- 在成员姓名后添加角色标签，组长显示蓝色"组长"标签
- 导入了 `Tag` 组件用于角色标识

## 修复结果

### 修复前
- 组长登录后只能看到小组中的销售员数据
- 缺少组长自己的统计信息
- 无法区分成员角色

### 修复后
- 组长登录后可以看到包括自己在内的所有小组成员数据
- 每个成员都显示角色标识（组长/销售员）
- 统计数据完整准确

### 测试验证

**测试账号**: 李组长 (13800000002)
**测试结果**:
```json
{
  "userStats": [
    {
      "userId": 3,
      "userName": "李组长",
      "userRole": "leader",
      "teamName": "华东销售组7091",
      "customerCount": 11,
      "followCount": 0
    },
    {
      "userId": 5,
      "userName": "徐小刚",
      "userRole": "sales",
      "teamName": "华东销售组7091",
      "customerCount": 2,
      "followCount": 10
    },
    {
      "userId": 6,
      "userName": "徐小亮",
      "userRole": "sales",
      "teamName": "华东销售组7091",
      "customerCount": 1,
      "followCount": 3
    }
  ]
}
```

## 功能验证

创建了测试页面 `test-leader-statistics-final.html` 用于验证功能：
- ✅ 包含组长数据
- ✅ 显示角色标识
- ✅ 统计数据准确
- ✅ 权限控制正确

## 总结

此次修复确保了组长小组成员统计功能的完整性，组长现在可以查看包括自己在内的所有小组成员的统计数据，并且能够清楚地区分每个成员的角色。这提高了系统的实用性和用户体验。 