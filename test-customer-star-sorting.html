<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·æ˜Ÿçº§æ’åºåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #40a9ff;
        }
        .star-display {
            color: #faad14;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #e8e8e8;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #fafafa;
            font-weight: 600;
        }
        .sort-button {
            background: #52c41a;
            font-size: 12px;
            padding: 4px 8px;
        }
        .sort-button.desc {
            background: #ff7875;
        }
    </style>
</head>
<body>
    <h1>ğŸŒŸ å®¢æˆ·æ˜Ÿçº§æ’åºåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•å®¢æˆ·ç®¡ç†é¡µé¢çš„æ˜Ÿçº§æ’åºåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p>
        <ul>
            <li>âœ… æ˜Ÿçº§å‡åºæ’åºï¼ˆ1æ˜Ÿ â†’ 5æ˜Ÿï¼‰</li>
            <li>âœ… æ˜Ÿçº§é™åºæ’åºï¼ˆ5æ˜Ÿ â†’ 1æ˜Ÿï¼‰</li>
            <li>âœ… æœ€æ–°è·Ÿè¿›æ—¶é—´æ’åº</li>
            <li>âœ… æ’åºçŠ¶æ€ä¿æŒ</li>
            <li>âœ… APIå‚æ•°ä¼ é€’éªŒè¯</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>1. æµ‹è¯•å®¢æˆ·æ˜Ÿçº§æ’åºAPI</h2>
        <p>æµ‹è¯•åç«¯APIæ˜¯å¦æ­£ç¡®å¤„ç†æ’åºå‚æ•°</p>
        <button onclick="testStarSortingAPI('descend')">æµ‹è¯•æ˜Ÿçº§é™åº</button>
        <button onclick="testStarSortingAPI('ascend')">æµ‹è¯•æ˜Ÿçº§å‡åº</button>
        <button onclick="testFollowTimeSorting('descend')">æµ‹è¯•è·Ÿè¿›æ—¶é—´é™åº</button>
        <button onclick="testFollowTimeSorting('ascend')">æµ‹è¯•è·Ÿè¿›æ—¶é—´å‡åº</button>
        <div id="api-test-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ¨¡æ‹Ÿå‰ç«¯æ’åºåŠŸèƒ½</h2>
        <p>æ¨¡æ‹Ÿå‰ç«¯è¡¨æ ¼æ’åºäº¤äº’</p>
        <button onclick="simulateFrontendSorting()">æ¨¡æ‹Ÿå‰ç«¯æ’åº</button>
        <div id="frontend-test-result" class="test-result"></div>
        
        <div id="mock-table-container"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æ’åºå‚æ•°éªŒè¯</h2>
        <p>éªŒè¯æ’åºå‚æ•°çš„æ­£ç¡®ä¼ é€’</p>
        <button onclick="validateSortParams()">éªŒè¯æ’åºå‚æ•°</button>
        <div id="params-test-result" class="test-result"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3001/api';
        let authToken = null;

        // æ¨¡æ‹Ÿå®¢æˆ·æ•°æ®
        const mockCustomers = [
            { id: 1, name: 'å®¢æˆ·A', starLevel: 5, lastFollowTime: '2025-06-04 10:00:00' },
            { id: 2, name: 'å®¢æˆ·B', starLevel: 3, lastFollowTime: '2025-06-03 15:30:00' },
            { id: 3, name: 'å®¢æˆ·C', starLevel: 1, lastFollowTime: '2025-06-04 09:15:00' },
            { id: 4, name: 'å®¢æˆ·D', starLevel: 4, lastFollowTime: '2025-06-02 14:20:00' },
            { id: 5, name: 'å®¢æˆ·E', starLevel: 2, lastFollowTime: '2025-06-04 11:45:00' },
        ];

        // æ¸²æŸ“æ˜Ÿçº§
        function renderStars(level) {
            return 'â˜…'.repeat(level) + 'â˜†'.repeat(5 - level);
        }

        // ç™»å½•è·å–token
        async function getAuthToken() {
            if (authToken) return authToken;
            
            try {
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: '13800000001', password: '123456' })
                });
                const data = await response.json();
                authToken = data.data?.token;
                return authToken;
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                return null;
            }
        }

        // æµ‹è¯•æ˜Ÿçº§æ’åºAPI
        async function testStarSortingAPI(sortOrder) {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æ˜Ÿçº§æ’åºAPI...</div>';
            
            try {
                const token = await getAuthToken();
                if (!token) {
                    resultDiv.innerHTML = '<div class="error">âŒ æ— æ³•è·å–è®¤è¯token</div>';
                    return;
                }

                const params = new URLSearchParams({
                    page: '1',
                    pageSize: '10',
                    sortField: 'starLevel',
                    sortOrder: sortOrder
                });

                const response = await fetch(`${BASE_URL}/customers?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.code === 200 && data.data?.list) {
                    const customers = data.data.list;
                    const starLevels = customers.map(c => c.starLevel);
                    
                    // éªŒè¯æ’åºæ˜¯å¦æ­£ç¡®
                    let isCorrectlySorted = true;
                    for (let i = 1; i < starLevels.length; i++) {
                        if (sortOrder === 'ascend') {
                            if (starLevels[i] < starLevels[i-1]) {
                                isCorrectlySorted = false;
                                break;
                            }
                        } else {
                            if (starLevels[i] > starLevels[i-1]) {
                                isCorrectlySorted = false;
                                break;
                            }
                        }
                    }
                    
                    let result = `<h3>æ˜Ÿçº§${sortOrder === 'ascend' ? 'å‡åº' : 'é™åº'}æ’åºæµ‹è¯•ç»“æœ:</h3>`;
                    result += `<div class="${isCorrectlySorted ? 'success' : 'error'}">`;
                    result += `${isCorrectlySorted ? 'âœ…' : 'âŒ'} æ’åº${isCorrectlySorted ? 'æ­£ç¡®' : 'é”™è¯¯'}</div>`;
                    result += `<p>è¿”å›å®¢æˆ·æ•°é‡: ${customers.length}</p>`;
                    result += `<p>æ˜Ÿçº§åºåˆ—: ${starLevels.join(' â†’ ')}</p>`;
                    
                    // æ˜¾ç¤ºå‰5ä¸ªå®¢æˆ·
                    result += '<table><tr><th>å®¢æˆ·åç§°</th><th>æ˜Ÿçº§</th><th>æœ€æ–°è·Ÿè¿›</th></tr>';
                    customers.slice(0, 5).forEach(customer => {
                        result += `<tr>
                            <td>${customer.name}</td>
                            <td class="star-display">${renderStars(customer.starLevel)} (${customer.starLevel}æ˜Ÿ)</td>
                            <td>${customer.lastFollowTime || '-'}</td>
                        </tr>`;
                    });
                    result += '</table>';
                    
                    resultDiv.innerHTML = result;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ APIè¿”å›é”™è¯¯: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•è·Ÿè¿›æ—¶é—´æ’åº
        async function testFollowTimeSorting(sortOrder) {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•è·Ÿè¿›æ—¶é—´æ’åºAPI...</div>';
            
            try {
                const token = await getAuthToken();
                if (!token) {
                    resultDiv.innerHTML = '<div class="error">âŒ æ— æ³•è·å–è®¤è¯token</div>';
                    return;
                }

                const params = new URLSearchParams({
                    page: '1',
                    pageSize: '10',
                    sortField: 'lastFollowTime',
                    sortOrder: sortOrder
                });

                const response = await fetch(`${BASE_URL}/customers?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    resultDiv.innerHTML = `<div class="success">âœ… è·Ÿè¿›æ—¶é—´${sortOrder === 'ascend' ? 'å‡åº' : 'é™åº'}æ’åºAPIè°ƒç”¨æˆåŠŸ</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ APIè¿”å›é”™è¯¯: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¨¡æ‹Ÿå‰ç«¯æ’åºåŠŸèƒ½
        function simulateFrontendSorting() {
            const resultDiv = document.getElementById('frontend-test-result');
            const tableContainer = document.getElementById('mock-table-container');
            
            let currentSort = { field: null, order: null };
            
            function renderTable(data, sortField, sortOrder) {
                let sortedData = [...data];
                
                if (sortField && sortOrder) {
                    sortedData.sort((a, b) => {
                        let aVal = a[sortField];
                        let bVal = b[sortField];
                        
                        if (sortField === 'lastFollowTime') {
                            aVal = new Date(aVal).getTime();
                            bVal = new Date(bVal).getTime();
                        }
                        
                        if (sortOrder === 'ascend') {
                            return aVal - bVal;
                        } else {
                            return bVal - aVal;
                        }
                    });
                }
                
                let table = '<table><tr>';
                table += '<th>å®¢æˆ·åç§°</th>';
                table += `<th>æ˜Ÿçº§ <button class="sort-button ${currentSort.field === 'starLevel' && currentSort.order === 'descend' ? 'desc' : ''}" onclick="sortTable('starLevel', '${currentSort.field === 'starLevel' && currentSort.order === 'descend' ? 'ascend' : 'descend'}')">æ’åº</button></th>`;
                table += `<th>æœ€æ–°è·Ÿè¿› <button class="sort-button ${currentSort.field === 'lastFollowTime' && currentSort.order === 'descend' ? 'desc' : ''}" onclick="sortTable('lastFollowTime', '${currentSort.field === 'lastFollowTime' && currentSort.order === 'descend' ? 'ascend' : 'descend'}')">æ’åº</button></th>`;
                table += '</tr>';
                
                sortedData.forEach(customer => {
                    table += `<tr>
                        <td>${customer.name}</td>
                        <td class="star-display">${renderStars(customer.starLevel)} (${customer.starLevel}æ˜Ÿ)</td>
                        <td>${customer.lastFollowTime}</td>
                    </tr>`;
                });
                table += '</table>';
                
                tableContainer.innerHTML = table;
            }
            
            window.sortTable = function(field, order) {
                currentSort = { field, order };
                renderTable(mockCustomers, field, order);
                
                resultDiv.innerHTML = `<div class="success">âœ… æ¨¡æ‹Ÿæ’åº: ${field} ${order === 'ascend' ? 'å‡åº' : 'é™åº'}</div>`;
            };
            
            renderTable(mockCustomers);
            resultDiv.innerHTML = '<div class="success">âœ… å‰ç«¯æ’åºæ¨¡æ‹Ÿå·²åŠ è½½ï¼Œç‚¹å‡»è¡¨æ ¼æ ‡é¢˜è¿›è¡Œæ’åº</div>';
        }

        // éªŒè¯æ’åºå‚æ•°
        function validateSortParams() {
            const resultDiv = document.getElementById('params-test-result');
            
            // æ¨¡æ‹Ÿå‰ç«¯å‚æ•°æ„å»º
            const testCases = [
                { sortField: 'starLevel', sortOrder: 'ascend' },
                { sortField: 'starLevel', sortOrder: 'descend' },
                { sortField: 'lastFollowTime', sortOrder: 'ascend' },
                { sortField: 'lastFollowTime', sortOrder: 'descend' },
                { sortField: null, sortOrder: null }
            ];
            
            let result = '<h3>æ’åºå‚æ•°éªŒè¯ç»“æœ:</h3>';
            
            testCases.forEach((testCase, index) => {
                const params = new URLSearchParams({
                    page: '1',
                    pageSize: '20'
                });
                
                if (testCase.sortField && testCase.sortOrder) {
                    params.append('sortField', testCase.sortField);
                    params.append('sortOrder', testCase.sortOrder);
                }
                
                const url = `${BASE_URL}/customers?${params.toString()}`;
                const isValid = testCase.sortField ? 
                    ['starLevel', 'lastFollowTime'].includes(testCase.sortField) && 
                    ['ascend', 'descend'].includes(testCase.sortOrder) : true;
                
                result += `<div class="${isValid ? 'success' : 'error'}">`;
                result += `æµ‹è¯• ${index + 1}: ${isValid ? 'âœ…' : 'âŒ'} `;
                result += `sortField=${testCase.sortField || 'null'}, sortOrder=${testCase.sortOrder || 'null'}`;
                result += `<br>URL: ${url}`;
                result += '</div><br>';
            });
            
            resultDiv.innerHTML = result;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å®¢æˆ·æ˜Ÿçº§æ’åºåŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html> 