# 教练专业化权限系统实现文档

## 概述

本文档描述了健身房SaaS系统中教练专业化权限控制功能的完整实现，包括数据库实体扩展、权限守卫、装饰器和示例控制器。

## 实现内容

### 1. 数据库实体扩展

#### 1.1 MembershipCard 实体扩展
- **文件**: `src/entities/membership-card.entity.ts`
- **新增字段**: `benefits` (jsonb类型)
- **功能**: 支持详细的会员权益配置
- **包含权益**:
  - `discountRate`: 折扣率
  - `freeServices`: 免费服务列表
  - `priorityBooking`: 优先预约权限
  - `guestPasses`: 访客通行证数量
  - `personalTrainingDiscount`: 私教折扣
  - `groupClassDiscount`: 团课折扣
  - `additionalBenefits`: 其他额外权益

#### 1.2 Coach 实体扩展
- **文件**: `src/entities/coach.entity.ts`
- **新增字段**:
  - `specializationType`: 专业化类型枚举 ('personal', 'group', 'both')
  - `businessSettings`: 业务设置 (jsonb类型)
- **业务设置包含**:
  - `canManagePersonalTraining`: 是否可管理私教
  - `canManageGroupClass`: 是否可管理团课
  - `maxStudentsPerClass`: 每班最大学员数
  - `specialties`: 专业领域
  - `certifications`: 认证资质
- **新增业务方法**:
  - `isPersonalTrainer()`: 判断是否为私教
  - `isGroupInstructor()`: 判断是否为团课教练
  - `canManagePersonalTraining()`: 是否可管理私教业务
  - `canManageGroupClass()`: 是否可管理团课业务
  - `getMaxStudentsPerClass()`: 获取最大学员数
  - `getSpecializationDescription()`: 获取专业化描述

### 2. 角色权限系统扩展

#### 2.1 新增角色
- **文件**: `src/services/seed.service.ts`
- **新增角色**:
  - `PERSONAL_TRAINER`: 私人教练角色
  - `GROUP_FITNESS_INSTRUCTOR`: 团课教练角色
- **保留原有**: `COACH` 角色（向后兼容）

#### 2.2 权限分配
- **私人教练权限**:
  - 会员管理（查看、编辑）
  - 私教管理（全部权限）
  - 预约管理（查看、编辑、删除）
  - 卡券管理（私教卡相关）
- **团课教练权限**:
  - 会员管理（查看、编辑）
  - 团课管理（全部权限）
  - 预约管理（查看、编辑、删除）
  - 卡券管理（团课卡相关）

### 3. 权限控制组件

#### 3.1 专业化守卫
- **文件**: `src/common/guards/specialization.guard.ts`
- **功能**: 验证教练的专业化类型权限
- **验证逻辑**:
  1. 检查用户是否为教练角色
  2. 获取教练信息
  3. 验证专业化类型匹配
  4. 将教练信息注入请求对象

#### 3.2 专业化装饰器
- **文件**: `src/common/decorators/specialization.decorator.ts`
- **提供装饰器**:
  - `@RequireSpecialization(type)`: 通用专业化要求
  - `@RequirePersonalTrainer()`: 要求私人教练
  - `@RequireGroupInstructor()`: 要求团课教练
- **自动集成**: JWT认证守卫 + 专业化守卫

### 4. 示例控制器

#### 4.1 私教业务控制器
- **文件**: `src/controllers/personal-training.controller.ts`
- **功能演示**:
  - 创建私教预约
  - 获取私教课程
  - 完成课程
  - 管理私教卡
  - 使用私教卡

#### 4.2 团课业务控制器
- **文件**: `src/controllers/group-class.controller.ts`
- **功能演示**:
  - 创建团课排期
  - 获取团课列表
  - 开始团课
  - 会员签到
  - 管理团课卡
  - 获取统计数据

## 使用方法

### 1. 基本使用

```typescript
// 要求私人教练权限
@RequirePersonalTrainer()
@Post('personal-training/bookings')
async createPersonalTrainingBooking() {
  // 只有私人教练可以访问
}

// 要求团课教练权限
@RequireGroupInstructor()
@Post('group-class/schedules')
async createGroupClassSchedule() {
  // 只有团课教练可以访问
}

// 通用专业化要求
@RequireSpecialization('personal')
@Get('personal-training/cards')
async getPersonalTrainingCards() {
  // 要求personal专业化类型
}
```

### 2. 获取教练信息

```typescript
@RequirePersonalTrainer()
async someMethod(@Request() req: any) {
  const coach: Coach = req.coach; // 从守卫注入的教练信息
  
  // 使用教练的业务方法
  if (coach.canManagePersonalTraining()) {
    // 执行私教相关业务
  }
  
  const maxStudents = coach.getMaxStudentsPerClass();
  // 其他业务逻辑
}
```

### 3. 教练专业化配置

```typescript
// 创建专业化教练
const coach = new Coach();
coach.specializationType = 'personal'; // 'personal' | 'group' | 'both'
coach.businessSettings = {
  canManagePersonalTraining: true,
  canManageGroupClass: false,
  maxStudentsPerClass: 0, // 私教不需要
  specialties: ['减脂', '增肌', '康复训练'],
  certifications: ['ACSM认证', 'NASM认证']
};
```

### 4. 会员卡权益配置

```typescript
// 配置会员卡权益
const membershipCard = new MembershipCard();
membershipCard.benefits = {
  discountRate: 0.1, // 10%折扣
  freeServices: ['体测', '营养咨询'],
  priorityBooking: true,
  guestPasses: 2,
  personalTrainingDiscount: 0.15,
  groupClassDiscount: 0.05,
  additionalBenefits: {
    freeParking: true,
    loungeAccess: true
  }
};
```

## 数据库迁移

系统会自动检测实体变更并生成迁移文件。如需手动迁移：

```bash
# 生成迁移
npm run migration:generate -- --name=AddCoachSpecializationAndMembershipBenefits

# 运行迁移
npm run migration:run
```

## 安全考虑

1. **权限验证**: 所有专业化相关的接口都必须使用相应的装饰器
2. **角色检查**: 守卫会验证用户是否具有教练角色
3. **专业化匹配**: 严格验证教练的专业化类型
4. **业务权限**: 通过教练实体的业务方法进行二次验证

## 扩展性

1. **新增专业化类型**: 在枚举中添加新类型
2. **自定义权限**: 扩展businessSettings字段
3. **新增装饰器**: 基于RequireSpecialization创建特定装饰器
4. **权限组合**: 支持多种专业化类型的组合验证

## 测试建议

1. **单元测试**: 测试教练实体的业务方法
2. **集成测试**: 测试守卫和装饰器的权限验证
3. **端到端测试**: 测试完整的API权限控制流程
4. **权限矩阵测试**: 验证不同角色的权限边界

## 总结

本实现提供了完整的教练专业化权限控制解决方案，支持：
- 灵活的教练专业化类型配置
- 细粒度的权限控制
- 丰富的会员权益管理
- 易于使用的装饰器API
- 良好的扩展性和维护性

通过这套系统，健身房可以根据教练的专业领域精确控制其业务权限，提高管理效率和服务质量。