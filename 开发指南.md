# 健身房SaaS系统开发指南

## 📋 目录

1. [系统架构优化方案](#系统架构优化方案)
2. [数据库设计优化](#数据库设计优化)
3. [角色权限系统实现](#角色权限系统实现)
4. [业务流程优化](#业务流程优化)
5. [API接口设计](#api接口设计)
6. [前端开发规范](#前端开发规范)
7. [实施计划](#实施计划)

## 🏗️ 系统架构优化方案

### 当前系统优势

✅ **已实现的核心功能**
- 完整的多品牌多门店架构
- 基础的角色权限系统
- 私教和团课业务分离
- 完善的预约和签到流程
- 多终端支持（Web + 小程序）

### 已完成的优化项目

✅ **角色细分优化** (已完成)
- `COACH`角色已细分为`PERSONAL_TRAINER`和`GROUP_FITNESS_INSTRUCTOR`
- 实现了角色专业化配置和权限细分
- 新增了`SpecializationGuard`和相关装饰器

✅ **业务实体完善** (已完成)
- 已扩展`Coach`实体，新增`specializationType`和`businessSettings`字段
- 已扩展`MembershipCard`实体，新增`benefits`字段用于权益配置
- 实现了卡券使用流程和权限控制基础架构

🔧 **业务流程优化** (进行中)
- 私教和团课业务流程标准化框架已建立
- 卡券扣费机制统一规范待完善

## 🗄️ 数据库设计优化

### 1. Coach实体扩展

**文件位置**: `backend/src/entities/coach.entity.ts`

```typescript
@Entity('coaches')
export class Coach {
  // ... 现有字段
  
  // 新增字段
  @Column({
    type: 'enum',
    enum: ['personal', 'group', 'both'],
    default: 'both'
  })
  specializationType: 'personal' | 'group' | 'both';
  
  @Column('jsonb', { nullable: true })
  businessSettings: {
    canManagePersonalTraining: boolean;
    canManageGroupClass: boolean;
    maxStudentsPerClass?: number;
    specialties: string[];
    certifications: string[];
  };
  
  // 业务方法
  isPersonalTrainer(): boolean {
    return this.specializationType === 'personal' || this.specializationType === 'both';
  }
  
  isGroupInstructor(): boolean {
    return this.specializationType === 'group' || this.specializationType === 'both';
  }
}
```

### 2. 新增MembershipCard实体

**文件位置**: `backend/src/entities/membership-card.entity.ts`

```typescript
@Entity('membership_cards')
export class MembershipCard {
  @PrimaryGeneratedColumn('uuid')
  id: string;
  
  @Column({ unique: true })
  cardNumber: string;
  
  @ManyToOne(() => Member, member => member.membershipCards)
  member: Member;
  
  @Column()
  memberId: string;
  
  @Column({
    type: 'enum',
    enum: ['basic', 'premium', 'vip'],
    default: 'basic'
  })
  type: 'basic' | 'premium' | 'vip';
  
  @Column({
    type: 'enum',
    enum: ['active', 'expired', 'suspended'],
    default: 'active'
  })
  status: 'active' | 'expired' | 'suspended';
  
  @Column('timestamp')
  validFrom: Date;
  
  @Column('timestamp')
  validTo: Date;
  
  @Column('jsonb')
  benefits: {
    discountRate: number;
    freeServices: string[];
    priorityBooking: boolean;
    guestPasses: number;
  };
  
  // 业务方法
  isValid(): boolean {
    const now = new Date();
    return this.status === 'active' && 
           this.validFrom <= now && 
           this.validTo >= now;
  }
  
  getDiscountRate(): number {
    return this.isValid() ? this.benefits.discountRate : 0;
  }
}
```

### 3. 角色权限系统扩展

**新增角色定义** (`backend/src/common/seed/seed.service.ts`):

```typescript
const roles = [
  // ... 现有角色
  {
    name: 'PERSONAL_TRAINER',
    displayName: '私人教练',
    description: '负责私教课程执行和会员服务',
    permissions: [
      'personal_training:manage',
      'member:view_assigned',
      'booking:manage_personal',
      'card:use_personal_training'
    ]
  },
  {
    name: 'GROUP_FITNESS_INSTRUCTOR',
    displayName: '团课教练',
    description: '负责团体课程执行和管理',
    permissions: [
      'group_class:manage',
      'member:view_class',
      'booking:manage_group',
      'card:use_group_class'
    ]
  }
];
```

## 🔐 角色权限系统实现 (已完成)

### 1. 专业化权限装饰器

**文件位置**: `backend/src/common/decorators/specialization.decorator.ts`

```typescript
// 专业化权限检查装饰器
export const RequireSpecialization = (type: 'personal' | 'group') => {
  return applyDecorators(
    UseGuards(JwtAuthGuard, SpecializationGuard),
    SetMetadata('specialization', type)
  );
};

// 便捷装饰器
export const RequirePersonalTrainer = () => RequireSpecialization('personal');
export const RequireGroupInstructor = () => RequireSpecialization('group');

// 使用示例
@RequirePersonalTrainer()
@Post('personal-training/bookings')
createPersonalTrainingBooking() {
  // 只有私人教练可以访问
}

@RequireGroupInstructor()
@Post('group-class/schedule')
createGroupClassSchedule() {
  // 只有团课教练可以访问
}
```

### 2. 专业化守卫实现

**文件位置**: `backend/src/common/guards/specialization.guard.ts`

```typescript
@Injectable()
export class SpecializationGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private coachesService: CoachesService
  ) {}
  
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const requiredSpecialization = this.reflector.get<string>(
      'specialization',
      context.getHandler()
    );
    
    if (!requiredSpecialization) {
      return true;
    }
    
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    
    // 检查用户是否为教练角色
    const isCoach = user.roles.some(role => 
      ['COACH', 'PERSONAL_TRAINER', 'GROUP_FITNESS_INSTRUCTOR'].includes(role.name)
    );
    
    if (!isCoach) {
      throw new ForbiddenException('只有教练可以访问此资源');
    }
    
    // 获取教练信息并检查专业化类型
    const coach = await this.coachesService.findByUserId(user.id);
    
    if (!coach) {
      throw new NotFoundException('教练信息不存在');
    }
    
    // 验证专业化类型
    const hasPermission = 
      (requiredSpecialization === 'personal' && coach.isPersonalTrainer()) ||
      (requiredSpecialization === 'group' && coach.isGroupInstructor());
    
    if (!hasPermission) {
      throw new ForbiddenException(
        `此功能需要${requiredSpecialization === 'personal' ? '私人教练' : '团课教练'}权限`
      );
    }
    
    return true;
  }
}
```

## 🔄 业务流程优化

### 1. 私教业务流程标准化

**文件位置**: `backend/src/personal-training/personal-training.service.ts`

```typescript
@Injectable()
export class PersonalTrainingService {
  
  async createBooking(createDto: CreatePersonalTrainingBookingDto, user: User) {
    // 1. 验证教练专业化
    const coach = await this.coachesService.findOne(createDto.coachId);
    if (!coach.isPersonalTrainer()) {
      throw new BadRequestException('教练不具备私教资质');
    }
    
    // 2. 验证私教卡
    const card = await this.personalTrainingCardsService.findOne(createDto.cardId);
    if (!card.canUse()) {
      throw new BadRequestException('私教卡不可用');
    }
    
    // 3. 创建预约
    const booking = await this.bookingsService.create({
      ...createDto,
      type: 'personal',
      memberId: user.member.id
    });
    
    // 4. 扣减次数
    await this.personalTrainingCardsService.useSession(createDto.cardId);
    
    return booking;
  }
  
  async completeSession(bookingId: string, user: User) {
    // 1. 验证预约状态
    const booking = await this.bookingsService.findOne(bookingId);
    
    // 2. 标记完成
    await this.bookingsService.complete(bookingId);
    
    // 3. 记录教练工作量
    await this.coachesService.recordWorkload(booking.coachId, {
      type: 'personal_training',
      duration: booking.duration,
      completedAt: new Date()
    });
    
    return booking;
  }
}
```

### 2. 团课业务流程标准化

**文件位置**: `backend/src/group-classes/group-classes.service.ts`

```typescript
@Injectable()
export class GroupClassesService {
  
  async createBooking(createDto: CreateGroupClassBookingDto, user: User) {
    // 1. 验证课程安排
    const schedule = await this.courseSchedulesService.findOne(createDto.scheduleId);
    
    // 2. 验证教练专业化
    const coach = await this.coachesService.findOne(schedule.coachId);
    if (!coach.isGroupInstructor()) {
      throw new BadRequestException('教练不具备团课资质');
    }
    
    // 3. 验证团课卡
    const card = await this.groupClassCardsService.findOne(createDto.cardId);
    if (!card.canUse()) {
      throw new BadRequestException('团课卡不可用');
    }
    
    // 4. 检查容量
    if (schedule.currentParticipants >= schedule.maxParticipants) {
      throw new BadRequestException('课程已满员');
    }
    
    // 5. 创建预约
    const booking = await this.bookingsService.createGroupClassBooking({
      ...createDto,
      memberId: user.member.id
    });
    
    // 6. 扣减次数
    await this.groupClassCardsService.useSession(createDto.cardId);
    
    return booking;
  }
}
```

## 🌐 API接口设计

### 1. 教练专业化管理接口

```typescript
// POST /api/coaches/{id}/specialize
@Post(':id/specialize')
@RequirePermissions('coach:manage')
async specializeCoach(
  @Param('id') id: string,
  @Body() dto: SpecializeCoachDto
) {
  return this.coachesService.updateSpecialization(id, dto);
}

// GET /api/coaches/personal-trainers
@Get('personal-trainers')
async getPersonalTrainers(@Query() query: QueryCoachDto) {
  return this.coachesService.findPersonalTrainers(query);
}

// GET /api/coaches/group-instructors
@Get('group-instructors')
async getGroupInstructors(@Query() query: QueryCoachDto) {
  return this.coachesService.findGroupInstructors(query);
}
```

### 2. 会籍卡管理接口

```typescript
// POST /api/membership-cards
@Post()
@RequirePermissions('membership_card:create')
async createMembershipCard(@Body() dto: CreateMembershipCardDto) {
  return this.membershipCardsService.create(dto);
}

// GET /api/membership-cards/member/:memberId
@Get('member/:memberId')
async getMembershipCards(@Param('memberId') memberId: string) {
  return this.membershipCardsService.findByMember(memberId);
}

// POST /api/membership-cards/:id/activate
@Post(':id/activate')
@RequirePermissions('membership_card:activate')
async activateCard(@Param('id') id: string) {
  return this.membershipCardsService.activate(id);
}
```

## 🎨 前端开发规范

### 1. 角色权限组件

**文件位置**: `frontend/src/components/RoleGuard.vue`

```vue
<template>
  <div v-if="hasPermission">
    <slot />
  </div>
</template>

<script setup lang="ts">
interface Props {
  roles?: string[];
  permissions?: string[];
  specialization?: 'personal' | 'group';
}

const props = defineProps<Props>();
const { user } = useAuth();

const hasPermission = computed(() => {
  // 角色检查
  if (props.roles) {
    const hasRole = props.roles.some(role => 
      user.value?.roles.includes(role)
    );
    if (!hasRole) return false;
  }
  
  // 权限检查
  if (props.permissions) {
    const hasPermission = props.permissions.some(permission => 
      user.value?.permissions.includes(permission)
    );
    if (!hasPermission) return false;
  }
  
  // 专业化检查
  if (props.specialization && user.value?.coach) {
    const coach = user.value.coach;
    if (props.specialization === 'personal' && !coach.isPersonalTrainer) {
      return false;
    }
    if (props.specialization === 'group' && !coach.isGroupInstructor) {
      return false;
    }
  }
  
  return true;
});
</script>
```

### 2. 业务组件示例

**私教预约组件**:
```vue
<template>
  <RoleGuard :roles="['MEMBER']">
    <div class="personal-training-booking">
      <!-- 私教预约界面 -->
    </div>
  </RoleGuard>
</template>
```

**教练管理组件**:
```vue
<template>
  <RoleGuard :permissions="['coach:manage']">
    <div class="coach-management">
      <!-- 教练管理界面 -->
    </div>
  </RoleGuard>
</template>
```

## 📅 实施计划

### 第一阶段：数据库优化 (1-2周)

1. **Coach实体扩展**
   - 添加`specializationType`字段
   - 添加`businessSettings`字段
   - 创建数据迁移脚本

2. **MembershipCard实体创建**
   - 创建新实体和数据表
   - 建立与Member的关联关系
   - 实现基础CRUD操作

3. **角色权限扩展**
   - 添加新角色定义
   - 创建细分权限
   - 更新种子数据

### 第二阶段：业务逻辑优化 (2-3周)

1. **教练专业化服务**
   - 实现专业化管理服务
   - 创建专业化守卫
   - 更新相关业务逻辑

2. **业务流程标准化**
   - 优化私教预约流程
   - 优化团课预约流程
   - 统一卡券使用机制

3. **API接口完善**
   - 新增专业化管理接口
   - 优化现有业务接口
   - 完善权限控制

### 第三阶段：前端适配 (2-3周)

1. **权限组件开发**
   - 创建角色守卫组件
   - 实现权限检查逻辑
   - 适配专业化显示

2. **业务界面优化**
   - 优化教练管理界面
   - 完善预约流程界面
   - 增强用户体验

3. **测试与部署**
   - 单元测试覆盖
   - 集成测试验证
   - 生产环境部署

### 风险评估与应对

**技术风险**:
- 数据迁移可能影响现有数据
- 权限变更可能影响现有用户

**应对措施**:
- 充分的数据备份
- 渐进式权限迁移
- 完善的回滚方案

**预期收益**:
- 提升系统业务清晰度
- 增强权限管理精确性
- 优化用户操作体验
- 为后续功能扩展奠定基础

---

## 📞 技术支持

如有技术问题，请参考：
- [系统架构优化方案.md](./系统架构优化方案.md)
- [PRD.md](./PRD.md)
- [README.md](./README.md)

或联系开发团队获取支持。