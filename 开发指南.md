# å¥èº«æˆ¿SaaSç³»ç»Ÿå¼€å‘æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ](#ç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ)
2. [æ•°æ®åº“è®¾è®¡ä¼˜åŒ–](#æ•°æ®åº“è®¾è®¡ä¼˜åŒ–)
3. [è§’è‰²æƒé™ç³»ç»Ÿå®ç°](#è§’è‰²æƒé™ç³»ç»Ÿå®ç°)
4. [ä¸šåŠ¡æµç¨‹ä¼˜åŒ–](#ä¸šåŠ¡æµç¨‹ä¼˜åŒ–)
5. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
6. [å‰ç«¯å¼€å‘è§„èŒƒ](#å‰ç«¯å¼€å‘è§„èŒƒ)
7. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

### å½“å‰ç³»ç»Ÿä¼˜åŠ¿

âœ… **å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½**
- å®Œæ•´çš„å¤šå“ç‰Œå¤šé—¨åº—æ¶æ„
- åŸºç¡€çš„è§’è‰²æƒé™ç³»ç»Ÿ
- ç§æ•™å’Œå›¢è¯¾ä¸šåŠ¡åˆ†ç¦»
- å®Œå–„çš„é¢„çº¦å’Œç­¾åˆ°æµç¨‹
- å¤šç»ˆç«¯æ”¯æŒï¼ˆWeb + å°ç¨‹åºï¼‰

### å·²å®Œæˆçš„ä¼˜åŒ–é¡¹ç›®

âœ… **è§’è‰²ç»†åˆ†ä¼˜åŒ–** (å·²å®Œæˆ)
- `COACH`è§’è‰²å·²ç»†åˆ†ä¸º`PERSONAL_TRAINER`å’Œ`GROUP_FITNESS_INSTRUCTOR`
- å®ç°äº†è§’è‰²ä¸“ä¸šåŒ–é…ç½®å’Œæƒé™ç»†åˆ†
- æ–°å¢äº†`SpecializationGuard`å’Œç›¸å…³è£…é¥°å™¨

âœ… **ä¸šåŠ¡å®ä½“å®Œå–„** (å·²å®Œæˆ)
- å·²æ‰©å±•`Coach`å®ä½“ï¼Œæ–°å¢`specializationType`å’Œ`businessSettings`å­—æ®µ
- å·²æ‰©å±•`MembershipCard`å®ä½“ï¼Œæ–°å¢`benefits`å­—æ®µç”¨äºæƒç›Šé…ç½®
- å®ç°äº†å¡åˆ¸ä½¿ç”¨æµç¨‹å’Œæƒé™æ§åˆ¶åŸºç¡€æ¶æ„

ğŸ”§ **ä¸šåŠ¡æµç¨‹ä¼˜åŒ–** (è¿›è¡Œä¸­)
- ç§æ•™å’Œå›¢è¯¾ä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–æ¡†æ¶å·²å»ºç«‹
- å¡åˆ¸æ‰£è´¹æœºåˆ¶ç»Ÿä¸€è§„èŒƒå¾…å®Œå–„

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡ä¼˜åŒ–

### 1. Coachå®ä½“æ‰©å±•

**æ–‡ä»¶ä½ç½®**: `backend/src/entities/coach.entity.ts`

```typescript
@Entity('coaches')
export class Coach {
  // ... ç°æœ‰å­—æ®µ
  
  // æ–°å¢å­—æ®µ
  @Column({
    type: 'enum',
    enum: ['personal', 'group', 'both'],
    default: 'both'
  })
  specializationType: 'personal' | 'group' | 'both';
  
  @Column('jsonb', { nullable: true })
  businessSettings: {
    canManagePersonalTraining: boolean;
    canManageGroupClass: boolean;
    maxStudentsPerClass?: number;
    specialties: string[];
    certifications: string[];
  };
  
  // ä¸šåŠ¡æ–¹æ³•
  isPersonalTrainer(): boolean {
    return this.specializationType === 'personal' || this.specializationType === 'both';
  }
  
  isGroupInstructor(): boolean {
    return this.specializationType === 'group' || this.specializationType === 'both';
  }
}
```

### 2. æ–°å¢MembershipCardå®ä½“

**æ–‡ä»¶ä½ç½®**: `backend/src/entities/membership-card.entity.ts`

```typescript
@Entity('membership_cards')
export class MembershipCard {
  @PrimaryGeneratedColumn('uuid')
  id: string;
  
  @Column({ unique: true })
  cardNumber: string;
  
  @ManyToOne(() => Member, member => member.membershipCards)
  member: Member;
  
  @Column()
  memberId: string;
  
  @Column({
    type: 'enum',
    enum: ['basic', 'premium', 'vip'],
    default: 'basic'
  })
  type: 'basic' | 'premium' | 'vip';
  
  @Column({
    type: 'enum',
    enum: ['active', 'expired', 'suspended'],
    default: 'active'
  })
  status: 'active' | 'expired' | 'suspended';
  
  @Column('timestamp')
  validFrom: Date;
  
  @Column('timestamp')
  validTo: Date;
  
  @Column('jsonb')
  benefits: {
    discountRate: number;
    freeServices: string[];
    priorityBooking: boolean;
    guestPasses: number;
  };
  
  // ä¸šåŠ¡æ–¹æ³•
  isValid(): boolean {
    const now = new Date();
    return this.status === 'active' && 
           this.validFrom <= now && 
           this.validTo >= now;
  }
  
  getDiscountRate(): number {
    return this.isValid() ? this.benefits.discountRate : 0;
  }
}
```

### 3. è§’è‰²æƒé™ç³»ç»Ÿæ‰©å±•

**æ–°å¢è§’è‰²å®šä¹‰** (`backend/src/common/seed/seed.service.ts`):

```typescript
const roles = [
  // ... ç°æœ‰è§’è‰²
  {
    name: 'PERSONAL_TRAINER',
    displayName: 'ç§äººæ•™ç»ƒ',
    description: 'è´Ÿè´£ç§æ•™è¯¾ç¨‹æ‰§è¡Œå’Œä¼šå‘˜æœåŠ¡',
    permissions: [
      'personal_training:manage',
      'member:view_assigned',
      'booking:manage_personal',
      'card:use_personal_training'
    ]
  },
  {
    name: 'GROUP_FITNESS_INSTRUCTOR',
    displayName: 'å›¢è¯¾æ•™ç»ƒ',
    description: 'è´Ÿè´£å›¢ä½“è¯¾ç¨‹æ‰§è¡Œå’Œç®¡ç†',
    permissions: [
      'group_class:manage',
      'member:view_class',
      'booking:manage_group',
      'card:use_group_class'
    ]
  }
];
```

## ğŸ” è§’è‰²æƒé™ç³»ç»Ÿå®ç° (å·²å®Œæˆ)

### 1. ä¸“ä¸šåŒ–æƒé™è£…é¥°å™¨

**æ–‡ä»¶ä½ç½®**: `backend/src/common/decorators/specialization.decorator.ts`

```typescript
// ä¸“ä¸šåŒ–æƒé™æ£€æŸ¥è£…é¥°å™¨
export const RequireSpecialization = (type: 'personal' | 'group') => {
  return applyDecorators(
    UseGuards(JwtAuthGuard, SpecializationGuard),
    SetMetadata('specialization', type)
  );
};

// ä¾¿æ·è£…é¥°å™¨
export const RequirePersonalTrainer = () => RequireSpecialization('personal');
export const RequireGroupInstructor = () => RequireSpecialization('group');

// ä½¿ç”¨ç¤ºä¾‹
@RequirePersonalTrainer()
@Post('personal-training/bookings')
createPersonalTrainingBooking() {
  // åªæœ‰ç§äººæ•™ç»ƒå¯ä»¥è®¿é—®
}

@RequireGroupInstructor()
@Post('group-class/schedule')
createGroupClassSchedule() {
  // åªæœ‰å›¢è¯¾æ•™ç»ƒå¯ä»¥è®¿é—®
}
```

### 2. ä¸“ä¸šåŒ–å®ˆå«å®ç°

**æ–‡ä»¶ä½ç½®**: `backend/src/common/guards/specialization.guard.ts`

```typescript
@Injectable()
export class SpecializationGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private coachesService: CoachesService
  ) {}
  
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const requiredSpecialization = this.reflector.get<string>(
      'specialization',
      context.getHandler()
    );
    
    if (!requiredSpecialization) {
      return true;
    }
    
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºæ•™ç»ƒè§’è‰²
    const isCoach = user.roles.some(role => 
      ['COACH', 'PERSONAL_TRAINER', 'GROUP_FITNESS_INSTRUCTOR'].includes(role.name)
    );
    
    if (!isCoach) {
      throw new ForbiddenException('åªæœ‰æ•™ç»ƒå¯ä»¥è®¿é—®æ­¤èµ„æº');
    }
    
    // è·å–æ•™ç»ƒä¿¡æ¯å¹¶æ£€æŸ¥ä¸“ä¸šåŒ–ç±»å‹
    const coach = await this.coachesService.findByUserId(user.id);
    
    if (!coach) {
      throw new NotFoundException('æ•™ç»ƒä¿¡æ¯ä¸å­˜åœ¨');
    }
    
    // éªŒè¯ä¸“ä¸šåŒ–ç±»å‹
    const hasPermission = 
      (requiredSpecialization === 'personal' && coach.isPersonalTrainer()) ||
      (requiredSpecialization === 'group' && coach.isGroupInstructor());
    
    if (!hasPermission) {
      throw new ForbiddenException(
        `æ­¤åŠŸèƒ½éœ€è¦${requiredSpecialization === 'personal' ? 'ç§äººæ•™ç»ƒ' : 'å›¢è¯¾æ•™ç»ƒ'}æƒé™`
      );
    }
    
    return true;
  }
}
```

## ğŸ”„ ä¸šåŠ¡æµç¨‹ä¼˜åŒ–

### 1. ç§æ•™ä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–

**æ–‡ä»¶ä½ç½®**: `backend/src/personal-training/personal-training.service.ts`

```typescript
@Injectable()
export class PersonalTrainingService {
  
  async createBooking(createDto: CreatePersonalTrainingBookingDto, user: User) {
    // 1. éªŒè¯æ•™ç»ƒä¸“ä¸šåŒ–
    const coach = await this.coachesService.findOne(createDto.coachId);
    if (!coach.isPersonalTrainer()) {
      throw new BadRequestException('æ•™ç»ƒä¸å…·å¤‡ç§æ•™èµ„è´¨');
    }
    
    // 2. éªŒè¯ç§æ•™å¡
    const card = await this.personalTrainingCardsService.findOne(createDto.cardId);
    if (!card.canUse()) {
      throw new BadRequestException('ç§æ•™å¡ä¸å¯ç”¨');
    }
    
    // 3. åˆ›å»ºé¢„çº¦
    const booking = await this.bookingsService.create({
      ...createDto,
      type: 'personal',
      memberId: user.member.id
    });
    
    // 4. æ‰£å‡æ¬¡æ•°
    await this.personalTrainingCardsService.useSession(createDto.cardId);
    
    return booking;
  }
  
  async completeSession(bookingId: string, user: User) {
    // 1. éªŒè¯é¢„çº¦çŠ¶æ€
    const booking = await this.bookingsService.findOne(bookingId);
    
    // 2. æ ‡è®°å®Œæˆ
    await this.bookingsService.complete(bookingId);
    
    // 3. è®°å½•æ•™ç»ƒå·¥ä½œé‡
    await this.coachesService.recordWorkload(booking.coachId, {
      type: 'personal_training',
      duration: booking.duration,
      completedAt: new Date()
    });
    
    return booking;
  }
}
```

### 2. å›¢è¯¾ä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–

**æ–‡ä»¶ä½ç½®**: `backend/src/group-classes/group-classes.service.ts`

```typescript
@Injectable()
export class GroupClassesService {
  
  async createBooking(createDto: CreateGroupClassBookingDto, user: User) {
    // 1. éªŒè¯è¯¾ç¨‹å®‰æ’
    const schedule = await this.courseSchedulesService.findOne(createDto.scheduleId);
    
    // 2. éªŒè¯æ•™ç»ƒä¸“ä¸šåŒ–
    const coach = await this.coachesService.findOne(schedule.coachId);
    if (!coach.isGroupInstructor()) {
      throw new BadRequestException('æ•™ç»ƒä¸å…·å¤‡å›¢è¯¾èµ„è´¨');
    }
    
    // 3. éªŒè¯å›¢è¯¾å¡
    const card = await this.groupClassCardsService.findOne(createDto.cardId);
    if (!card.canUse()) {
      throw new BadRequestException('å›¢è¯¾å¡ä¸å¯ç”¨');
    }
    
    // 4. æ£€æŸ¥å®¹é‡
    if (schedule.currentParticipants >= schedule.maxParticipants) {
      throw new BadRequestException('è¯¾ç¨‹å·²æ»¡å‘˜');
    }
    
    // 5. åˆ›å»ºé¢„çº¦
    const booking = await this.bookingsService.createGroupClassBooking({
      ...createDto,
      memberId: user.member.id
    });
    
    // 6. æ‰£å‡æ¬¡æ•°
    await this.groupClassCardsService.useSession(createDto.cardId);
    
    return booking;
  }
}
```

## ğŸŒ APIæ¥å£è®¾è®¡

### 1. æ•™ç»ƒä¸“ä¸šåŒ–ç®¡ç†æ¥å£

```typescript
// POST /api/coaches/{id}/specialize
@Post(':id/specialize')
@RequirePermissions('coach:manage')
async specializeCoach(
  @Param('id') id: string,
  @Body() dto: SpecializeCoachDto
) {
  return this.coachesService.updateSpecialization(id, dto);
}

// GET /api/coaches/personal-trainers
@Get('personal-trainers')
async getPersonalTrainers(@Query() query: QueryCoachDto) {
  return this.coachesService.findPersonalTrainers(query);
}

// GET /api/coaches/group-instructors
@Get('group-instructors')
async getGroupInstructors(@Query() query: QueryCoachDto) {
  return this.coachesService.findGroupInstructors(query);
}
```

### 2. ä¼šç±å¡ç®¡ç†æ¥å£

```typescript
// POST /api/membership-cards
@Post()
@RequirePermissions('membership_card:create')
async createMembershipCard(@Body() dto: CreateMembershipCardDto) {
  return this.membershipCardsService.create(dto);
}

// GET /api/membership-cards/member/:memberId
@Get('member/:memberId')
async getMembershipCards(@Param('memberId') memberId: string) {
  return this.membershipCardsService.findByMember(memberId);
}

// POST /api/membership-cards/:id/activate
@Post(':id/activate')
@RequirePermissions('membership_card:activate')
async activateCard(@Param('id') id: string) {
  return this.membershipCardsService.activate(id);
}
```

## ğŸ¨ å‰ç«¯å¼€å‘è§„èŒƒ

### 1. è§’è‰²æƒé™ç»„ä»¶

**æ–‡ä»¶ä½ç½®**: `frontend/src/components/RoleGuard.vue`

```vue
<template>
  <div v-if="hasPermission">
    <slot />
  </div>
</template>

<script setup lang="ts">
interface Props {
  roles?: string[];
  permissions?: string[];
  specialization?: 'personal' | 'group';
}

const props = defineProps<Props>();
const { user } = useAuth();

const hasPermission = computed(() => {
  // è§’è‰²æ£€æŸ¥
  if (props.roles) {
    const hasRole = props.roles.some(role => 
      user.value?.roles.includes(role)
    );
    if (!hasRole) return false;
  }
  
  // æƒé™æ£€æŸ¥
  if (props.permissions) {
    const hasPermission = props.permissions.some(permission => 
      user.value?.permissions.includes(permission)
    );
    if (!hasPermission) return false;
  }
  
  // ä¸“ä¸šåŒ–æ£€æŸ¥
  if (props.specialization && user.value?.coach) {
    const coach = user.value.coach;
    if (props.specialization === 'personal' && !coach.isPersonalTrainer) {
      return false;
    }
    if (props.specialization === 'group' && !coach.isGroupInstructor) {
      return false;
    }
  }
  
  return true;
});
</script>
```

### 2. ä¸šåŠ¡ç»„ä»¶ç¤ºä¾‹

**ç§æ•™é¢„çº¦ç»„ä»¶**:
```vue
<template>
  <RoleGuard :roles="['MEMBER']">
    <div class="personal-training-booking">
      <!-- ç§æ•™é¢„çº¦ç•Œé¢ -->
    </div>
  </RoleGuard>
</template>
```

**æ•™ç»ƒç®¡ç†ç»„ä»¶**:
```vue
<template>
  <RoleGuard :permissions="['coach:manage']">
    <div class="coach-management">
      <!-- æ•™ç»ƒç®¡ç†ç•Œé¢ -->
    </div>
  </RoleGuard>
</template>
```

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“ä¼˜åŒ– (1-2å‘¨)

1. **Coachå®ä½“æ‰©å±•**
   - æ·»åŠ `specializationType`å­—æ®µ
   - æ·»åŠ `businessSettings`å­—æ®µ
   - åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬

2. **MembershipCardå®ä½“åˆ›å»º**
   - åˆ›å»ºæ–°å®ä½“å’Œæ•°æ®è¡¨
   - å»ºç«‹ä¸Memberçš„å…³è”å…³ç³»
   - å®ç°åŸºç¡€CRUDæ“ä½œ

3. **è§’è‰²æƒé™æ‰©å±•**
   - æ·»åŠ æ–°è§’è‰²å®šä¹‰
   - åˆ›å»ºç»†åˆ†æƒé™
   - æ›´æ–°ç§å­æ•°æ®

### ç¬¬äºŒé˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘ä¼˜åŒ– (2-3å‘¨)

1. **æ•™ç»ƒä¸“ä¸šåŒ–æœåŠ¡**
   - å®ç°ä¸“ä¸šåŒ–ç®¡ç†æœåŠ¡
   - åˆ›å»ºä¸“ä¸šåŒ–å®ˆå«
   - æ›´æ–°ç›¸å…³ä¸šåŠ¡é€»è¾‘

2. **ä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–**
   - ä¼˜åŒ–ç§æ•™é¢„çº¦æµç¨‹
   - ä¼˜åŒ–å›¢è¯¾é¢„çº¦æµç¨‹
   - ç»Ÿä¸€å¡åˆ¸ä½¿ç”¨æœºåˆ¶

3. **APIæ¥å£å®Œå–„**
   - æ–°å¢ä¸“ä¸šåŒ–ç®¡ç†æ¥å£
   - ä¼˜åŒ–ç°æœ‰ä¸šåŠ¡æ¥å£
   - å®Œå–„æƒé™æ§åˆ¶

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯é€‚é… (2-3å‘¨)

1. **æƒé™ç»„ä»¶å¼€å‘**
   - åˆ›å»ºè§’è‰²å®ˆå«ç»„ä»¶
   - å®ç°æƒé™æ£€æŸ¥é€»è¾‘
   - é€‚é…ä¸“ä¸šåŒ–æ˜¾ç¤º

2. **ä¸šåŠ¡ç•Œé¢ä¼˜åŒ–**
   - ä¼˜åŒ–æ•™ç»ƒç®¡ç†ç•Œé¢
   - å®Œå–„é¢„çº¦æµç¨‹ç•Œé¢
   - å¢å¼ºç”¨æˆ·ä½“éªŒ

3. **æµ‹è¯•ä¸éƒ¨ç½²**
   - å•å…ƒæµ‹è¯•è¦†ç›–
   - é›†æˆæµ‹è¯•éªŒè¯
   - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### é£é™©è¯„ä¼°ä¸åº”å¯¹

**æŠ€æœ¯é£é™©**:
- æ•°æ®è¿ç§»å¯èƒ½å½±å“ç°æœ‰æ•°æ®
- æƒé™å˜æ›´å¯èƒ½å½±å“ç°æœ‰ç”¨æˆ·

**åº”å¯¹æªæ–½**:
- å……åˆ†çš„æ•°æ®å¤‡ä»½
- æ¸è¿›å¼æƒé™è¿ç§»
- å®Œå–„çš„å›æ»šæ–¹æ¡ˆ

**é¢„æœŸæ”¶ç›Š**:
- æå‡ç³»ç»Ÿä¸šåŠ¡æ¸…æ™°åº¦
- å¢å¼ºæƒé™ç®¡ç†ç²¾ç¡®æ€§
- ä¼˜åŒ–ç”¨æˆ·æ“ä½œä½“éªŒ
- ä¸ºåç»­åŠŸèƒ½æ‰©å±•å¥ å®šåŸºç¡€

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰æŠ€æœ¯é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [ç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ.md](./ç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ.md)
- [PRD.md](./PRD.md)
- [README.md](./README.md)

æˆ–è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒã€‚