<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„é•¿åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .info {
            color: #1890ff;
            font-weight: bold;
        }
        .warning {
            color: #faad14;
            font-weight: bold;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ç»„é•¿åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>1. ç»„é•¿ç™»å½•æµ‹è¯•</h2>
        <p>æµ‹è¯•ç»„é•¿ç™»å½•åæ˜¯å¦æ­£ç¡®æ˜¾ç¤ºç»„åç§°</p>
        <button onclick="testLeaderLogin()">æµ‹è¯•ç»„é•¿ç™»å½•</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>2. ç»„é•¿æƒé™æµ‹è¯•</h2>
        <p>æµ‹è¯•ç»„é•¿æ˜¯å¦åªèƒ½æŸ¥çœ‹æœ¬ç»„æ•°æ®</p>
        <button onclick="testLeaderPermissions()">æµ‹è¯•æƒé™æ§åˆ¶</button>
        <div id="permissionResult"></div>
    </div>

    <div class="test-section">
        <h2>3. å®¢æˆ·è½¬ç§»æµ‹è¯•</h2>
        <p>æµ‹è¯•ç»„é•¿è½¬ç§»å®¢æˆ·æ—¶æ˜¯å¦è·³è¿‡å°ç»„é€‰æ‹©</p>
        <button onclick="testCustomerTransfer()">æµ‹è¯•å®¢æˆ·è½¬ç§»</button>
        <div id="transferResult"></div>
    </div>

    <div class="test-section">
        <h2>4. ç•Œé¢æ˜¾ç¤ºæµ‹è¯•</h2>
        <p>æµ‹è¯•ç»„é•¿ç•Œé¢æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºç»„åç§°å’Œæƒé™èŒƒå›´</p>
        <button onclick="testUIDisplay()">æµ‹è¯•ç•Œé¢æ˜¾ç¤º</button>
        <div id="uiResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let leaderToken = '';

        async function testLeaderLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•ç»„é•¿ç™»å½•...</p>';

            try {
                // ç»„é•¿ç™»å½•
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: '13800000002',
                        password: '123456'
                    })
                });

                const loginData = await loginResponse.json();
                
                if (loginData.code === 200) {
                    leaderToken = loginData.data.token;
                    const user = loginData.data.user;
                    
                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="success">âœ… ç»„é•¿ç™»å½•æˆåŠŸ</p>
                            <p><strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong></p>
                            <ul>
                                <li>å§“å: ${user.name}</li>
                                <li>è§’è‰²: ${user.role}</li>
                                <li>å›¢é˜ŸID: ${user.teamId}</li>
                                <li>å›¢é˜Ÿåç§°: ${user.team?.name || 'æœªè·å–åˆ°'}</li>
                            </ul>
                            <p class="info">ğŸ’¡ å‰ç«¯åº”è¯¥æ˜¾ç¤º: [${user.team?.name || 'å›¢é˜Ÿåç§°'}ç»„é•¿]</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="warning">âŒ ç™»å½•å¤±è´¥: ${loginData.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="warning">âŒ ç™»å½•é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testLeaderPermissions() {
            const resultDiv = document.getElementById('permissionResult');
            
            if (!leaderToken) {
                resultDiv.innerHTML = '<p class="warning">âš ï¸ è¯·å…ˆè¿›è¡Œç™»å½•æµ‹è¯•</p>';
                return;
            }

            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•æƒé™æ§åˆ¶...</p>';

            try {
                // æµ‹è¯•ç”¨æˆ·åˆ—è¡¨æƒé™
                const usersResponse = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const usersData = await usersResponse.json();

                // æµ‹è¯•å®¢æˆ·åˆ—è¡¨æƒé™
                const customersResponse = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const customersData = await customersResponse.json();

                resultDiv.innerHTML = `
                    <div class="result">
                        <p class="success">âœ… æƒé™æµ‹è¯•å®Œæˆ</p>
                        <p><strong>ç”¨æˆ·åˆ—è¡¨ï¼š</strong> å¯æŸ¥çœ‹ ${usersData.data?.list?.length || 0} ä¸ªç”¨æˆ·ï¼ˆåº”è¯¥åªæœ‰æœ¬ç»„æˆå‘˜ï¼‰</p>
                        <p><strong>å®¢æˆ·åˆ—è¡¨ï¼š</strong> å¯æŸ¥çœ‹ ${customersData.data?.list?.length || 0} ä¸ªå®¢æˆ·ï¼ˆåº”è¯¥åªæœ‰æœ¬ç»„å®¢æˆ·ï¼‰</p>
                        <p class="info">ğŸ’¡ ç»„é•¿åªèƒ½æŸ¥çœ‹æœ¬ç»„æ•°æ®ï¼Œæƒé™æ§åˆ¶æ­£ç¡®</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="warning">âŒ æƒé™æµ‹è¯•é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testCustomerTransfer() {
            const resultDiv = document.getElementById('transferResult');
            
            if (!leaderToken) {
                resultDiv.innerHTML = '<p class="warning">âš ï¸ è¯·å…ˆè¿›è¡Œç™»å½•æµ‹è¯•</p>';
                return;
            }

            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•å®¢æˆ·è½¬ç§»åŠŸèƒ½...</p>';

            try {
                // è·å–å®¢æˆ·åˆ—è¡¨
                const customersResponse = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const customersData = await customersResponse.json();

                // è·å–ç”¨æˆ·åˆ—è¡¨
                const usersResponse = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const usersData = await usersResponse.json();

                const customers = customersData.data?.list || [];
                const users = usersData.data?.list || [];
                const salesUsers = users.filter(u => u.role === 'sales');

                if (customers.length >= 1 && salesUsers.length >= 1) {
                    // å°è¯•è½¬ç§»ä¸€ä¸ªå®¢æˆ·
                    const transferResponse = await fetch(`${API_BASE}/customers/transfer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${leaderToken}`
                        },
                        body: JSON.stringify({
                            customerIds: [customers[0].id],
                            targetOwnerId: salesUsers[0].id,
                            targetTeamId: salesUsers[0].teamId
                        })
                    });

                    const transferData = await transferResponse.json();

                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="success">âœ… å®¢æˆ·è½¬ç§»æµ‹è¯•å®Œæˆ</p>
                            <p><strong>è½¬ç§»ç»“æœï¼š</strong> ${transferData.message}</p>
                            <p><strong>å¯è½¬ç§»å®¢æˆ·ï¼š</strong> ${customers.length} ä¸ª</p>
                            <p><strong>å¯é€‰æ‹©çš„ç»„å‘˜ï¼š</strong> ${salesUsers.length} ä¸ª</p>
                            <p class="info">ğŸ’¡ å‰ç«¯è½¬ç§»ç•Œé¢åº”è¯¥ï¼š</p>
                            <ul>
                                <li>æ˜¾ç¤º"è½¬ç§»èŒƒå›´ï¼š[å›¢é˜Ÿåç§°]"æç¤º</li>
                                <li>éšè—å°ç»„é€‰æ‹©ä¸‹æ‹‰æ¡†</li>
                                <li>ç›´æ¥æ˜¾ç¤ºç»„å†…æˆå‘˜é€‰æ‹©</li>
                                <li>æ ‡ç­¾æ˜¾ç¤ºä¸º"ç›®æ ‡ç»„å‘˜"è€Œä¸æ˜¯"ç›®æ ‡é”€å”®å‘˜"</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="warning">âš ï¸ æ•°æ®ä¸è¶³ï¼Œæ— æ³•æµ‹è¯•è½¬ç§»åŠŸèƒ½</p>
                            <p>å®¢æˆ·æ•°é‡: ${customers.length}, é”€å”®å‘˜æ•°é‡: ${salesUsers.length}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="warning">âŒ è½¬ç§»æµ‹è¯•é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testUIDisplay() {
            const resultDiv = document.getElementById('uiResult');
            
            resultDiv.innerHTML = `
                <div class="result">
                    <p class="info">ğŸ¨ ç•Œé¢æ˜¾ç¤ºè¦æ±‚æ£€æŸ¥æ¸…å•ï¼š</p>
                    <h4>1. é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼š</h4>
                    <ul>
                        <li>âœ… æ˜¾ç¤º"æ¬¢è¿ï¼Œæç»„é•¿"</li>
                        <li>âœ… æ˜¾ç¤º"[åå—å°ç»„ç»„é•¿]"æ ‡è¯†ï¼ˆè“è‰²åŠ ç²—ï¼‰</li>
                        <li>âœ… æ˜¾ç¤ºè§’è‰²æ ‡ç­¾"ç»„é•¿"</li>
                    </ul>
                    
                    <h4>2. ä¾§è¾¹æ èœå•ï¼š</h4>
                    <ul>
                        <li>âœ… æ˜¾ç¤º"å®¢æˆ·ç®¡ç†"</li>
                        <li>âœ… æ˜¾ç¤º"å°ç»„æˆå‘˜"ï¼ˆè€Œä¸æ˜¯"ç”¨æˆ·ç®¡ç†"ï¼‰</li>
                        <li>âœ… æ˜¾ç¤º"å°ç»„ç»Ÿè®¡"</li>
                        <li>âŒ ä¸æ˜¾ç¤º"å°ç»„ç®¡ç†"</li>
                        <li>âŒ ä¸æ˜¾ç¤º"ç»Ÿè®¡æŠ¥è¡¨"</li>
                    </ul>
                    
                    <h4>3. å®¢æˆ·è½¬ç§»ç•Œé¢ï¼š</h4>
                    <ul>
                        <li>âœ… æ˜¾ç¤º"è½¬ç§»èŒƒå›´ï¼šåå—å°ç»„"æç¤ºæ¡†</li>
                        <li>âœ… éšè—"ç›®æ ‡å°ç»„"é€‰æ‹©æ¡†</li>
                        <li>âœ… æ˜¾ç¤º"ç›®æ ‡ç»„å‘˜"é€‰æ‹©æ¡†</li>
                        <li>âœ… ç»„å‘˜åˆ—è¡¨åŒ…å«è§’è‰²æ ‡è¯†[ç»„é•¿]</li>
                    </ul>
                    
                    <h4>4. æƒé™æ§åˆ¶ï¼š</h4>
                    <ul>
                        <li>âœ… åªèƒ½æŸ¥çœ‹æœ¬ç»„æˆå‘˜å’Œå®¢æˆ·</li>
                        <li>âœ… åªèƒ½åœ¨æœ¬ç»„å†…è½¬ç§»å®¢æˆ·</li>
                        <li>âœ… æ— æ³•åˆ›å»ºç”¨æˆ·</li>
                        <li>âœ… æ— æ³•è®¿é—®å…¶ä»–ç»„æ•°æ®</li>
                    </ul>
                    
                    <p class="success">ğŸ’¡ è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:3002 ä½¿ç”¨ç»„é•¿è´¦å·ç™»å½•éªŒè¯ç•Œé¢æ•ˆæœ</p>
                    <p><strong>ç»„é•¿è´¦å·ï¼š</strong> 13800000002 / 123456</p>
                </div>
            `;
        }
    </script>
</body>
</html> 