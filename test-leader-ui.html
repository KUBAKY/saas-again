<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>组长功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .info {
            color: #1890ff;
            font-weight: bold;
        }
        .warning {
            color: #faad14;
            font-weight: bold;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>组长功能测试页面</h1>
    
    <div class="test-section">
        <h2>1. 组长登录测试</h2>
        <p>测试组长登录后是否正确显示组名称</p>
        <button onclick="testLeaderLogin()">测试组长登录</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>2. 组长权限测试</h2>
        <p>测试组长是否只能查看本组数据</p>
        <button onclick="testLeaderPermissions()">测试权限控制</button>
        <div id="permissionResult"></div>
    </div>

    <div class="test-section">
        <h2>3. 客户转移测试</h2>
        <p>测试组长转移客户时是否跳过小组选择</p>
        <button onclick="testCustomerTransfer()">测试客户转移</button>
        <div id="transferResult"></div>
    </div>

    <div class="test-section">
        <h2>4. 界面显示测试</h2>
        <p>测试组长界面是否正确显示组名称和权限范围</p>
        <button onclick="testUIDisplay()">测试界面显示</button>
        <div id="uiResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let leaderToken = '';

        async function testLeaderLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<p>正在测试组长登录...</p>';

            try {
                // 组长登录
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: '13800000002',
                        password: '123456'
                    })
                });

                const loginData = await loginResponse.json();
                
                if (loginData.code === 200) {
                    leaderToken = loginData.data.token;
                    const user = loginData.data.user;
                    
                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="success">✅ 组长登录成功</p>
                            <p><strong>用户信息：</strong></p>
                            <ul>
                                <li>姓名: ${user.name}</li>
                                <li>角色: ${user.role}</li>
                                <li>团队ID: ${user.teamId}</li>
                                <li>团队名称: ${user.team?.name || '未获取到'}</li>
                            </ul>
                            <p class="info">💡 前端应该显示: [${user.team?.name || '团队名称'}组长]</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="warning">❌ 登录失败: ${loginData.message}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="warning">❌ 登录错误: ${error.message}</p>`;
            }
        }

        async function testLeaderPermissions() {
            const resultDiv = document.getElementById('permissionResult');
            
            if (!leaderToken) {
                resultDiv.innerHTML = '<p class="warning">⚠️ 请先进行登录测试</p>';
                return;
            }

            resultDiv.innerHTML = '<p>正在测试权限控制...</p>';

            try {
                // 测试用户列表权限
                const usersResponse = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const usersData = await usersResponse.json();

                // 测试客户列表权限
                const customersResponse = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const customersData = await customersResponse.json();

                resultDiv.innerHTML = `
                    <div class="result">
                        <p class="success">✅ 权限测试完成</p>
                        <p><strong>用户列表：</strong> 可查看 ${usersData.data?.list?.length || 0} 个用户（应该只有本组成员）</p>
                        <p><strong>客户列表：</strong> 可查看 ${customersData.data?.list?.length || 0} 个客户（应该只有本组客户）</p>
                        <p class="info">💡 组长只能查看本组数据，权限控制正确</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="warning">❌ 权限测试错误: ${error.message}</p>`;
            }
        }

        async function testCustomerTransfer() {
            const resultDiv = document.getElementById('transferResult');
            
            if (!leaderToken) {
                resultDiv.innerHTML = '<p class="warning">⚠️ 请先进行登录测试</p>';
                return;
            }

            resultDiv.innerHTML = '<p>正在测试客户转移功能...</p>';

            try {
                // 获取客户列表
                const customersResponse = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const customersData = await customersResponse.json();

                // 获取用户列表
                const usersResponse = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${leaderToken}`
                    }
                });
                const usersData = await usersResponse.json();

                const customers = customersData.data?.list || [];
                const users = usersData.data?.list || [];
                const salesUsers = users.filter(u => u.role === 'sales');

                if (customers.length >= 1 && salesUsers.length >= 1) {
                    // 尝试转移一个客户
                    const transferResponse = await fetch(`${API_BASE}/customers/transfer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${leaderToken}`
                        },
                        body: JSON.stringify({
                            customerIds: [customers[0].id],
                            targetOwnerId: salesUsers[0].id,
                            targetTeamId: salesUsers[0].teamId
                        })
                    });

                    const transferData = await transferResponse.json();

                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="success">✅ 客户转移测试完成</p>
                            <p><strong>转移结果：</strong> ${transferData.message}</p>
                            <p><strong>可转移客户：</strong> ${customers.length} 个</p>
                            <p><strong>可选择的组员：</strong> ${salesUsers.length} 个</p>
                            <p class="info">💡 前端转移界面应该：</p>
                            <ul>
                                <li>显示"转移范围：[团队名称]"提示</li>
                                <li>隐藏小组选择下拉框</li>
                                <li>直接显示组内成员选择</li>
                                <li>标签显示为"目标组员"而不是"目标销售员"</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <p class="warning">⚠️ 数据不足，无法测试转移功能</p>
                            <p>客户数量: ${customers.length}, 销售员数量: ${salesUsers.length}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="warning">❌ 转移测试错误: ${error.message}</p>`;
            }
        }

        async function testUIDisplay() {
            const resultDiv = document.getElementById('uiResult');
            
            resultDiv.innerHTML = `
                <div class="result">
                    <p class="info">🎨 界面显示要求检查清单：</p>
                    <h4>1. 顶部用户信息区域：</h4>
                    <ul>
                        <li>✅ 显示"欢迎，李组长"</li>
                        <li>✅ 显示"[华南小组组长]"标识（蓝色加粗）</li>
                        <li>✅ 显示角色标签"组长"</li>
                    </ul>
                    
                    <h4>2. 侧边栏菜单：</h4>
                    <ul>
                        <li>✅ 显示"客户管理"</li>
                        <li>✅ 显示"小组成员"（而不是"用户管理"）</li>
                        <li>✅ 显示"小组统计"</li>
                        <li>❌ 不显示"小组管理"</li>
                        <li>❌ 不显示"统计报表"</li>
                    </ul>
                    
                    <h4>3. 客户转移界面：</h4>
                    <ul>
                        <li>✅ 显示"转移范围：华南小组"提示框</li>
                        <li>✅ 隐藏"目标小组"选择框</li>
                        <li>✅ 显示"目标组员"选择框</li>
                        <li>✅ 组员列表包含角色标识[组长]</li>
                    </ul>
                    
                    <h4>4. 权限控制：</h4>
                    <ul>
                        <li>✅ 只能查看本组成员和客户</li>
                        <li>✅ 只能在本组内转移客户</li>
                        <li>✅ 无法创建用户</li>
                        <li>✅ 无法访问其他组数据</li>
                    </ul>
                    
                    <p class="success">💡 请在浏览器中访问 http://localhost:3002 使用组长账号登录验证界面效果</p>
                    <p><strong>组长账号：</strong> 13800000002 / 123456</p>
                </div>
            `;
        }
    </script>
</body>
</html> 