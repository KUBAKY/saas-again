<template>
  <el-dialog
    v-model="dialogVisible"
    :title="`${coach?.name} - 收入统计`"
    width="800px"
    :close-on-click-modal="false"
  >
    <div v-if="coach" class="earnings-content">
      <!-- 统计卡片 -->
      <el-row :gutter="20" class="stats-row">
        <el-col :span="6">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class=\"stat-icon total\">\n                <el-icon><Money /></el-icon>\n              </div>\n              <div class=\"stat-info\">\n                <div class=\"stat-value\">¥{{ earnings.totalEarnings?.toLocaleString() || 0 }}</div>\n                <div class=\"stat-label\">累计收入</div>\n              </div>\n            </div>\n          </el-card>\n        </el-col>\n        <el-col :span=\"6\">\n          <el-card class=\"stat-card\">\n            <div class=\"stat-content\">\n              <div class=\"stat-icon current\">\n                <el-icon><Wallet /></el-icon>\n              </div>\n              <div class=\"stat-info\">\n                <div class=\"stat-value\">¥{{ earnings.currentMonthEarnings?.toLocaleString() || 0 }}</div>\n                <div class=\"stat-label\">本月收入</div>\n              </div>\n            </div>\n          </el-card>\n        </el-col>\n        <el-col :span=\"6\">\n          <el-card class=\"stat-card\">\n            <div class=\"stat-content\">\n              <div class=\"stat-icon sessions\">\n                <el-icon><Trophy /></el-icon>\n              </div>\n              <div class=\"stat-info\">\n                <div class=\"stat-value\">{{ coach.totalSessions || 0 }}</div>\n                <div class=\"stat-label\">总课时</div>\n              </div>\n            </div>\n          </el-card>\n        </el-col>\n        <el-col :span=\"6\">\n          <el-card class=\"stat-card\">\n            <div class=\"stat-content\">\n              <div class=\"stat-icon rate\">\n                <el-icon><PriceTag /></el-icon>\n              </div>\n              <div class=\"stat-info\">\n                <div class=\"stat-value\">¥{{ coach.hourlyRate || 0 }}</div>\n                <div class=\"stat-label\">课时费</div>\n              </div>\n            </div>\n          </el-card>\n        </el-col>\n      </el-row>\n\n      <!-- 时间筛选 -->\n      <el-card class=\"filter-card\">\n        <el-row :gutter=\"20\">\n          <el-col :span=\"12\">\n            <el-date-picker\n              v-model=\"dateRange\"\n              type=\"monthrange\"\n              range-separator=\"至\"\n              start-placeholder=\"开始月份\"\n              end-placeholder=\"结束月份\"\n              format=\"YYYY年MM月\"\n              value-format=\"YYYY-MM\"\n              @change=\"handleDateRangeChange\"\n            />\n          </el-col>\n          <el-col :span=\"12\">\n            <div class=\"filter-actions\">\n              <el-button @click=\"setQuickRange('thisMonth')\">本月</el-button>\n              <el-button @click=\"setQuickRange('lastMonth')\">上月</el-button>\n              <el-button @click=\"setQuickRange('thisQuarter')\">本季度</el-button>\n              <el-button @click=\"setQuickRange('thisYear')\">今年</el-button>\n            </div>\n          </el-col>\n        </el-row>\n      </el-card>\n\n      <!-- 月度收入图表 -->\n      <el-card class=\"chart-card\">\n        <template #header>\n          <span>月度收入趋势</span>\n        </template>\n        <div id=\"earningsChart\" class=\"earnings-chart\"></div>\n      </el-card>\n\n      <!-- 收入明细 -->\n      <el-card class=\"details-card\">\n        <template #header>\n          <div class=\"details-header\">\n            <span>收入明细</span>\n            <el-button size=\"small\" @click=\"handleExportDetails\">\n              <el-icon><Download /></el-icon>\n              导出明细\n            </el-button>\n          </div>\n        </template>\n        \n        <el-table\n          v-loading=\"loading\"\n          :data=\"earnings.sessions || []\"\n          stripe\n        >\n          <el-table-column prop=\"date\" label=\"日期\" width=\"120\">\n            <template #default=\"{ row }\">\n              {{ formatDate(row.date) }}\n            </template>\n          </el-table-column>\n          \n          <el-table-column prop=\"course\" label=\"课程\" width=\"150\" />\n          \n          <el-table-column prop=\"member\" label=\"学员\" width=\"120\" />\n          \n          <el-table-column label=\"课时费\" width=\"100\">\n            <template #default=\"{ row }\">\n              ¥{{ row.earnings?.toLocaleString() || 0 }}\n            </template>\n          </el-table-column>\n          \n          <el-table-column label=\"提成\" width=\"100\">\n            <template #default=\"{ row }\">\n              ¥{{ row.commission?.toLocaleString() || 0 }}\n            </template>\n          </el-table-column>\n          \n          <el-table-column label=\"实际收入\" width=\"100\">\n            <template #default=\"{ row }\">\n              <span class=\"earnings-amount\">\n                ¥{{ ((row.earnings || 0) + (row.commission || 0)).toLocaleString() }}\n              </span>\n            </template>\n          </el-table-column>\n          \n          <el-table-column label=\"状态\" width=\"80\">\n            <template #default=\"{ row }\">\n              <el-tag\n                :type=\"getPaymentStatusType(row.paymentStatus)\"\n                size=\"small\"\n              >\n                {{ getPaymentStatusText(row.paymentStatus) }}\n              </el-tag>\n            </template>\n          </el-table-column>\n        </el-table>\n        \n        <!-- 分页 -->\n        <div class=\"pagination-wrapper\">\n          <el-pagination\n            v-model:current-page=\"pagination.page\"\n            v-model:page-size=\"pagination.limit\"\n            :total=\"pagination.total\"\n            :page-sizes=\"[10, 20, 50, 100]\"\n            layout=\"total, sizes, prev, pager, next, jumper\"\n            @size-change=\"fetchEarnings\"\n            @current-change=\"fetchEarnings\"\n          />\n        </div>\n      </el-card>\n    </div>\n    \n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"dialogVisible = false\">关闭</el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, reactive, computed, watch, nextTick } from 'vue'\nimport { ElMessage } from 'element-plus'\nimport {\n  Money,\n  Wallet,\n  Trophy,\n  PriceTag,\n  Download\n} from '@element-plus/icons-vue'\nimport { coachesApi, type Coach, type CoachEarnings } from '@/api/coaches'\nimport * as echarts from 'echarts'\n\ninterface Props {\n  modelValue: boolean\n  coach?: Coach | null\n}\n\ninterface Emits {\n  (e: 'update:modelValue', value: boolean): void\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  coach: null\n})\n\nconst emit = defineEmits<Emits>()\n\n// 响应式数据\nconst loading = ref(false)\nconst dateRange = ref<[string, string]>(['2024-01', '2024-12'])\nconst earnings = ref<CoachEarnings>({\n  totalEarnings: 0,\n  currentMonthEarnings: 0,\n  sessions: [],\n  monthlyStats: []\n})\n\nconst pagination = reactive({\n  page: 1,\n  limit: 20,\n  total: 0\n})\n\nlet chart: echarts.ECharts | null = null\n\n// 计算属性\nconst dialogVisible = computed({\n  get: () => props.modelValue,\n  set: (value) => emit('update:modelValue', value)\n})\n\n// 监听对话框显示\nwatch(dialogVisible, (visible) => {\n  if (visible) {\n    nextTick(() => {\n      initChart()\n      fetchEarnings()\n    })\n  } else {\n    if (chart) {\n      chart.dispose()\n      chart = null\n    }\n  }\n})\n\n// 监听教练变化\nwatch(() => props.coach, () => {\n  if (props.coach && dialogVisible.value) {\n    fetchEarnings()\n  }\n})\n\n// 获取收入数据\nconst fetchEarnings = async () => {\n  if (!props.coach) return\n  \n  try {\n    loading.value = true\n    const [startDate, endDate] = dateRange.value\n    \n    const response = await coachesApi.getCoachEarnings(props.coach.id, {\n      startDate,\n      endDate\n    })\n    \n    earnings.value = response\n    pagination.total = response.sessions.length\n    \n    updateChart()\n  } catch (error) {\n    console.error('获取收入数据失败:', error)\n    ElMessage.error('获取收入数据失败')\n  } finally {\n    loading.value = false\n  }\n}\n\n// 初始化图表\nconst initChart = () => {\n  const chartDom = document.getElementById('earningsChart')\n  if (!chartDom) return\n  \n  chart = echarts.init(chartDom)\n  updateChart()\n}\n\n// 更新图表\nconst updateChart = () => {\n  if (!chart || !earnings.value.monthlyStats) return\n  \n  const option = {\n    tooltip: {\n      trigger: 'axis',\n      axisPointer: {\n        type: 'cross'\n      },\n      formatter: (params: any[]) => {\n        const data = params[0]\n        return `\n          <div>\n            <div>${data.name}</div>\n            <div>收入: ¥${data.value.toLocaleString()}</div>\n            <div>课时: ${earnings.value.monthlyStats[data.dataIndex]?.sessions || 0} 节</div>\n          </div>\n        `\n      }\n    },\n    grid: {\n      left: '3%',\n      right: '4%',\n      bottom: '3%',\n      containLabel: true\n    },\n    xAxis: {\n      type: 'category',\n      data: earnings.value.monthlyStats.map(item => item.month),\n      axisLine: {\n        lineStyle: {\n          color: '#8392A5'\n        }\n      }\n    },\n    yAxis: {\n      type: 'value',\n      axisLabel: {\n        formatter: (value: number) => `¥${value.toLocaleString()}`\n      },\n      axisLine: {\n        lineStyle: {\n          color: '#8392A5'\n        }\n      },\n      splitLine: {\n        lineStyle: {\n          color: 'rgba(131, 146, 165, 0.1)'\n        }\n      }\n    },\n    series: [\n      {\n        name: '收入',\n        type: 'line',\n        smooth: true,\n        symbol: 'circle',\n        symbolSize: 6,\n        itemStyle: {\n          color: '#667eea'\n        },\n        areaStyle: {\n          color: {\n            type: 'linear',\n            x: 0,\n            y: 0,\n            x2: 0,\n            y2: 1,\n            colorStops: [\n              { offset: 0, color: 'rgba(102, 126, 234, 0.3)' },\n              { offset: 1, color: 'rgba(102, 126, 234, 0.05)' }\n            ]\n          }\n        },\n        data: earnings.value.monthlyStats.map(item => item.earnings)\n      }\n    ]\n  }\n  \n  chart.setOption(option)\n}\n\n// 事件处理\nconst handleDateRangeChange = () => {\n  fetchEarnings()\n}\n\nconst setQuickRange = (type: string) => {\n  const now = new Date()\n  const year = now.getFullYear()\n  const month = now.getMonth() + 1\n  \n  switch (type) {\n    case 'thisMonth':\n      dateRange.value = [\n        `${year}-${month.toString().padStart(2, '0')}`,\n        `${year}-${month.toString().padStart(2, '0')}`\n      ]\n      break\n    case 'lastMonth':\n      const lastMonth = month === 1 ? 12 : month - 1\n      const lastMonthYear = month === 1 ? year - 1 : year\n      dateRange.value = [\n        `${lastMonthYear}-${lastMonth.toString().padStart(2, '0')}`,\n        `${lastMonthYear}-${lastMonth.toString().padStart(2, '0')}`\n      ]\n      break\n    case 'thisQuarter':\n      const quarterStart = Math.floor((month - 1) / 3) * 3 + 1\n      const quarterEnd = quarterStart + 2\n      dateRange.value = [\n        `${year}-${quarterStart.toString().padStart(2, '0')}`,\n        `${year}-${quarterEnd.toString().padStart(2, '0')}`\n      ]\n      break\n    case 'thisYear':\n      dateRange.value = [`${year}-01`, `${year}-12`]\n      break\n  }\n  \n  fetchEarnings()\n}\n\nconst handleExportDetails = () => {\n  // 实现导出功能\n  ElMessage.info('导出功能开发中')\n}\n\n// 工具函数\nconst formatDate = (dateStr: string) => {\n  if (!dateStr) return '-'\n  return new Date(dateStr).toLocaleDateString('zh-CN')\n}\n\nconst getPaymentStatusType = (status: string) => {\n  const types: Record<string, string> = {\n    paid: 'success',\n    pending: 'warning',\n    failed: 'danger'\n  }\n  return types[status] || 'info'\n}\n\nconst getPaymentStatusText = (status: string) => {\n  const texts: Record<string, string> = {\n    paid: '已发放',\n    pending: '待发放',\n    failed: '发放失败'\n  }\n  return texts[status] || '未知'\n}\n</script>\n\n<style scoped lang=\"scss\">\n.earnings-content {\n  .stats-row {\n    margin-bottom: 20px;\n    \n    .stat-card {\n      .stat-content {\n        display: flex;\n        align-items: center;\n        \n        .stat-icon {\n          width: 50px;\n          height: 50px;\n          border-radius: 12px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          margin-right: 15px;\n          font-size: 24px;\n          color: white;\n          \n          &.total {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          }\n          \n          &.current {\n            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\n          }\n          \n          &.sessions {\n            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);\n          }\n          \n          &.rate {\n            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);\n            color: #333;\n          }\n        }\n        \n        .stat-info {\n          .stat-value {\n            font-size: 20px;\n            font-weight: 600;\n            color: #333;\n            line-height: 1;\n            margin-bottom: 5px;\n          }\n          \n          .stat-label {\n            font-size: 14px;\n            color: #666;\n          }\n        }\n      }\n    }\n  }\n  \n  .filter-card {\n    margin-bottom: 20px;\n    \n    .filter-actions {\n      display: flex;\n      gap: 8px;\n      justify-content: flex-end;\n    }\n  }\n  \n  .chart-card {\n    margin-bottom: 20px;\n    \n    .earnings-chart {\n      height: 300px;\n    }\n  }\n  \n  .details-card {\n    .details-header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n    \n    .earnings-amount {\n      font-weight: 600;\n      color: #67c23a;\n    }\n    \n    .pagination-wrapper {\n      display: flex;\n      justify-content: center;\n      margin-top: 20px;\n    }\n  }\n}\n\n.dialog-footer {\n  text-align: right;\n}\n</style>"