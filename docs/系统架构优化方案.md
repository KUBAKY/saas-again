# å¥èº«æˆ¿SaaSç³»ç»Ÿæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
- [1. ç³»ç»Ÿç°çŠ¶åˆ†æ](#1-ç³»ç»Ÿç°çŠ¶åˆ†æ)
- [2. è§’è‰²ä¸šåŠ¡å…³ç³»æ¢³ç†](#2-è§’è‰²ä¸šåŠ¡å…³ç³»æ¢³ç†)
- [3. æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ](#3-æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ)
- [4. å„ç«¯åŠŸèƒ½äº¤äº’ä¼˜åŒ–](#4-å„ç«¯åŠŸèƒ½äº¤äº’ä¼˜åŒ–)
- [5. å®æ–½è·¯çº¿å›¾](#5-å®æ–½è·¯çº¿å›¾)

## 1. ç³»ç»Ÿç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¶æ„ä¼˜åŠ¿
âœ… **å®Œå–„çš„å¤šç§Ÿæˆ·æ¶æ„**ï¼šBrand -> Store -> User å±‚çº§æ¸…æ™°  
âœ… **çµæ´»çš„æƒé™ç³»ç»Ÿ**ï¼šRole-Permission åŠ¨æ€åˆ†é…  
âœ… **ä¸šåŠ¡ç±»å‹åŒºåˆ†**ï¼šç§æ•™ã€å›¢è¯¾ã€å·¥ä½œåŠåˆ†ç¦»  
âœ… **é¢„çº¦ç³»ç»Ÿå®Œæ•´**ï¼šæ”¯æŒä¸åŒä¸šåŠ¡ç±»å‹çš„é¢„çº¦æµç¨‹  
âœ… **å¡åˆ¸ç³»ç»Ÿç‹¬ç«‹**ï¼šç§æ•™å¡ã€å›¢è¯¾å¡ã€ä¼šç±å¡åˆ†åˆ«ç®¡ç†  

### 1.2 å¾…ä¼˜åŒ–é—®é¢˜
âŒ **æ•™ç»ƒè§’è‰²ç²—ç²’åº¦**ï¼šCOACHè§’è‰²æœªç»†åˆ†ä¸“ä¸šç±»å‹  
âŒ **æƒé™åˆ†é…ä¸å¤Ÿç²¾ç»†**ï¼šç¼ºå°‘åŸºäºä¸šåŠ¡ç±»å‹çš„æƒé™æ§åˆ¶  
âŒ **ä¸šåŠ¡æµç¨‹äº¤å‰**ï¼šç§æ•™å’Œå›¢è¯¾ä¸šåŠ¡è¾¹ç•Œæ¨¡ç³Š  
âŒ **æ•°æ®éš”ç¦»ä¸å®Œå–„**ï¼šè·¨ä¸šåŠ¡ç±»å‹çš„æ•°æ®è®¿é—®æ§åˆ¶  

## 2. è§’è‰²ä¸šåŠ¡å…³ç³»æ¢³ç†

### 2.1 æ ¸å¿ƒè§’è‰²é‡æ–°å®šä¹‰

```mermaid
graph TD
    A[ADMIN ç³»ç»Ÿç®¡ç†å‘˜] --> B[BRAND_MANAGER å“ç‰Œç®¡ç†è€…]
    B --> C[STORE_MANAGER é—¨åº—ç®¡ç†è€…]
    C --> D[PERSONAL_TRAINER ç§äººæ•™ç»ƒ]
    C --> E[GROUP_FITNESS_INSTRUCTOR å›¢è¯¾æ•™ç»ƒ]
    C --> F[RECEPTIONIST å‰å°æ¥å¾…]
    B --> G[MEMBER å¥èº«ä¼šå‘˜]
```

### 2.2 è§’è‰²æƒé™çŸ©é˜µ

| è§’è‰² | ç§æ•™ä¸šåŠ¡ | å›¢è¯¾ä¸šåŠ¡ | ä¼šå‘˜ç®¡ç† | å¡åˆ¸ç®¡ç† | è´¢åŠ¡ç®¡ç† |
|------|----------|----------|----------|----------|----------|
| ADMIN | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| BRAND_MANAGER | âœ… æŸ¥çœ‹/ç»Ÿè®¡ | âœ… æŸ¥çœ‹/ç»Ÿè®¡ | âœ… æŸ¥çœ‹/ç»Ÿè®¡ | âœ… æŸ¥çœ‹/ç»Ÿè®¡ | âœ… æŸ¥çœ‹/ç»Ÿè®¡ |
| STORE_MANAGER | âœ… ç®¡ç† | âœ… ç®¡ç† | âœ… ç®¡ç† | âœ… ç®¡ç† | âœ… æŸ¥çœ‹/ç»Ÿè®¡ |
| PERSONAL_TRAINER | âœ… æ‰§è¡Œ | âŒ æ— æƒé™ | âœ… æŸ¥çœ‹(åˆ†é…) | âœ… ä½¿ç”¨(ç§æ•™å¡) | âŒ æ— æƒé™ |
| GROUP_FITNESS_INSTRUCTOR | âŒ æ— æƒé™ | âœ… æ‰§è¡Œ | âœ… æŸ¥çœ‹(è¯¾ç¨‹) | âœ… ä½¿ç”¨(å›¢è¯¾å¡) | âŒ æ— æƒé™ |
| RECEPTIONIST | âœ… é¢„çº¦/ç­¾åˆ° | âœ… é¢„çº¦/ç­¾åˆ° | âœ… æœåŠ¡ | âœ… é”€å”®/æ¿€æ´» | âŒ æ— æƒé™ |
| MEMBER | âœ… é¢„çº¦/è¯„ä»· | âœ… é¢„çº¦/è¯„ä»· | âœ… ä¸ªäººä¿¡æ¯ | âœ… æŸ¥çœ‹/ä½¿ç”¨ | âŒ æ— æƒé™ |

### 2.3 ä¸šåŠ¡æµç¨‹é‡æ–°è®¾è®¡

#### ç§æ•™ä¸šåŠ¡æµç¨‹
```
1. ç§äººæ•™ç»ƒåˆ›å»ºç§æ•™è¯¾ç¨‹ (Course.type = 'personal')
2. ä¼šå‘˜è´­ä¹°ç§æ•™å¡ (PersonalTrainingCard)
3. ç§æ•™å¡åˆ†é…ç»™æŒ‡å®šæ•™ç»ƒ (PersonalTrainingCard.coachId)
4. ä¼šå‘˜é¢„çº¦ç§æ•™è¯¾ç¨‹ (Booking, æ— éœ€CourseSchedule)
5. ç§äººæ•™ç»ƒç¡®è®¤é¢„çº¦
6. è¯¾ç¨‹æ‰§è¡Œä¸ç­¾åˆ°
7. ç§æ•™å¡æ‰£æ¬¡ (PersonalTrainingCard.use())
8. è¯¾ç¨‹è¯„ä»·ä¸ç»“ç®—
```

#### å›¢è¯¾ä¸šåŠ¡æµç¨‹
```
1. å›¢è¯¾æ•™ç»ƒåˆ›å»ºå›¢è¯¾è¯¾ç¨‹ (Course.type = 'group')
2. å›¢è¯¾æ•™ç»ƒè®¾ç½®è¯¾ç¨‹æ’æœŸ (CourseSchedule)
3. ä¼šå‘˜è´­ä¹°å›¢è¯¾å¡ (GroupClassCard)
4. ä¼šå‘˜é¢„çº¦å›¢è¯¾æ—¶æ®µ (Booking.courseScheduleId)
5. ç³»ç»Ÿè‡ªåŠ¨ç¡®è®¤é¢„çº¦
6. è¯¾ç¨‹æ‰§è¡Œä¸æ‰¹é‡ç­¾åˆ°
7. å›¢è¯¾å¡æ‰£æ¬¡ (GroupClassCard.use())
8. è¯¾ç¨‹è¯„ä»·ä¸ç»“ç®—
```

## 3. æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 Coachå®ä½“æ‰©å±•
```typescript
// åœ¨ coach.entity.ts ä¸­æ·»åŠ 
@Column({
  type: 'enum',
  enum: ['personal', 'group', 'both'],
  default: 'both',
  comment: 'æ•™ç»ƒä¸“ä¸šç±»å‹',
})
specializationType: 'personal' | 'group' | 'both';

@Column({
  type: 'jsonb',
  nullable: true,
  comment: 'æ•™ç»ƒä¸šåŠ¡é…ç½®',
})
businessSettings?: {
  personalTraining?: {
    hourlyRate: number;
    availableHours: string[];
    maxDailyClients: number;
  };
  groupFitness?: {
    maxClassSize: number;
    specialtyClasses: string[];
    preferredTimeSlots: string[];
  };
};
```

### 3.2 æ–°å¢è§’è‰²å®šä¹‰
```typescript
// åœ¨ seed.service.ts ä¸­æ›´æ–°è§’è‰²æ•°æ®
const rolesData = [
  // ... ç°æœ‰è§’è‰²
  {
    name: 'PERSONAL_TRAINER',
    displayName: 'ç§äººæ•™ç»ƒ',
    description: 'ä¸“é—¨è´Ÿè´£ä¸€å¯¹ä¸€ç§æ•™è¯¾ç¨‹æœåŠ¡',
    type: 'system' as const,
    priority: 75,
  },
  {
    name: 'GROUP_FITNESS_INSTRUCTOR',
    displayName: 'å›¢è¯¾æ•™ç»ƒ',
    description: 'ä¸“é—¨è´Ÿè´£å›¢ä½“è¯¾ç¨‹æ•™å­¦',
    type: 'system' as const,
    priority: 75,
  },
];
```

### 3.3 æƒé™ç»†åŒ–å®šä¹‰
```typescript
// æ–°å¢æƒé™å®šä¹‰
const newPermissions = [
  // ç§æ•™ä¸“å±æƒé™
  {
    name: 'personal_training:execute',
    displayName: 'æ‰§è¡Œç§æ•™è¯¾ç¨‹',
    group: 'ç§æ•™ç®¡ç†',
    resource: 'personal_training',
    action: 'execute',
  },
  {
    name: 'personal_training_card:use',
    displayName: 'ä½¿ç”¨ç§æ•™å¡',
    group: 'ç§æ•™ç®¡ç†',
    resource: 'personal_training_card',
    action: 'use',
  },
  // å›¢è¯¾ä¸“å±æƒé™
  {
    name: 'group_class:execute',
    displayName: 'æ‰§è¡Œå›¢è¯¾',
    group: 'å›¢è¯¾ç®¡ç†',
    resource: 'group_class',
    action: 'execute',
  },
  {
    name: 'course_schedule:manage',
    displayName: 'ç®¡ç†è¯¾ç¨‹æ’æœŸ',
    group: 'å›¢è¯¾ç®¡ç†',
    resource: 'course_schedule',
    action: 'manage',
  },
];
```

### 3.4 æ•°æ®è¡¨å…³ç³»ä¼˜åŒ–
```sql
-- æ·»åŠ æ•™ç»ƒä¸“ä¸šç±»å‹ç´¢å¼•
CREATE INDEX idx_coaches_specialization ON coaches(specialization_type, store_id);

-- æ·»åŠ è¯¾ç¨‹ç±»å‹ä¸æ•™ç»ƒç±»å‹çš„å…³è”çº¦æŸ
ALTER TABLE courses ADD CONSTRAINT chk_course_coach_type 
CHECK (
  (type = 'personal' AND coach_id IN (
    SELECT id FROM coaches WHERE specialization_type IN ('personal', 'both')
  )) OR
  (type = 'group' AND coach_id IN (
    SELECT id FROM coaches WHERE specialization_type IN ('group', 'both')
  ))
);
```

## 4. å„ç«¯åŠŸèƒ½äº¤äº’ä¼˜åŒ–

### 4.1 åç«¯APIä¼˜åŒ–

#### æ•™ç»ƒç®¡ç†APIæ‰©å±•
```typescript
// coaches.controller.ts æ–°å¢æ¥å£
@Get('by-specialization/:type')
@ApiOperation({ summary: 'æŒ‰ä¸“ä¸šç±»å‹è·å–æ•™ç»ƒåˆ—è¡¨' })
getCoachesBySpecialization(
  @Param('type') type: 'personal' | 'group',
  @CurrentUser() user: User
) {
  return this.coachesService.findBySpecialization(type, user);
}

@Post(':id/assign-specialization')
@ApiOperation({ summary: 'åˆ†é…æ•™ç»ƒä¸“ä¸šç±»å‹' })
assignSpecialization(
  @Param('id') id: string,
  @Body() dto: { specializationType: 'personal' | 'group' | 'both' },
  @CurrentUser() user: User
) {
  return this.coachesService.updateSpecialization(id, dto.specializationType, user);
}
```

#### æƒé™æ§åˆ¶ä¸­é—´ä»¶
```typescript
// æ–°å¢ä¸šåŠ¡ç±»å‹æƒé™è£…é¥°å™¨
@BusinessTypeGuard('personal')
@Post('personal-training/create')
createPersonalTraining(@Body() dto: CreatePersonalTrainingDto) {
  // åªæœ‰ç§äººæ•™ç»ƒå¯ä»¥è®¿é—®
}

@BusinessTypeGuard('group')
@Post('group-class/schedule')
createGroupClassSchedule(@Body() dto: CreateScheduleDto) {
  // åªæœ‰å›¢è¯¾æ•™ç»ƒå¯ä»¥è®¿é—®
}
```

### 4.2 å‰ç«¯ç®¡ç†ç³»ç»Ÿä¼˜åŒ–

#### è§’è‰²ç®¡ç†ç•Œé¢
```vue
<!-- CoachManagement.vue -->
<template>
  <div class="coach-management">
    <!-- æ•™ç»ƒç±»å‹ç­›é€‰ -->
    <el-tabs v-model="activeTab" @tab-click="handleTabChange">
      <el-tab-pane label="å…¨éƒ¨æ•™ç»ƒ" name="all"></el-tab-pane>
      <el-tab-pane label="ç§äººæ•™ç»ƒ" name="personal"></el-tab-pane>
      <el-tab-pane label="å›¢è¯¾æ•™ç»ƒ" name="group"></el-tab-pane>
    </el-tabs>
    
    <!-- æ•™ç»ƒåˆ—è¡¨ -->
    <el-table :data="coaches" stripe>
      <el-table-column prop="name" label="å§“å"></el-table-column>
      <el-table-column prop="specializationType" label="ä¸“ä¸šç±»å‹">
        <template #default="{ row }">
          <el-tag :type="getSpecializationTagType(row.specializationType)">
            {{ getSpecializationText(row.specializationType) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ">
        <template #default="{ row }">
          <el-button @click="editSpecialization(row)">ç¼–è¾‘ä¸“ä¸š</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

### 4.3 å°ç¨‹åºç«¯ä¼˜åŒ–

#### ä¼šå‘˜ç«¯ - æ•™ç»ƒé€‰æ‹©ä¼˜åŒ–
```javascript
// pages/booking/booking.js
Page({
  data: {
    courseType: 'personal', // personal | group
    availableCoaches: [],
    selectedCoach: null,
  },
  
  onLoad(options) {
    this.setData({ courseType: options.type || 'personal' });
    this.loadCoachesByType();
  },
  
  async loadCoachesByType() {
    const { courseType } = this.data;
    try {
      const coaches = await api.getCoachesBySpecialization(courseType);
      this.setData({ availableCoaches: coaches });
    } catch (error) {
      wx.showToast({ title: 'åŠ è½½æ•™ç»ƒå¤±è´¥', icon: 'error' });
    }
  },
});
```

#### é—¨åº—ç«¯ - è§’è‰²æƒé™æ§åˆ¶
```javascript
// pages/courses/courses.js
Page({
  data: {
    userRole: '',
    canManagePersonalTraining: false,
    canManageGroupClass: false,
  },
  
  onLoad() {
    this.checkUserPermissions();
  },
  
  checkUserPermissions() {
    const userInfo = wx.getStorageSync('userInfo');
    const roles = userInfo.roles || [];
    
    this.setData({
      userRole: roles[0]?.name || '',
      canManagePersonalTraining: this.hasPermission(roles, 'personal_training'),
      canManageGroupClass: this.hasPermission(roles, 'group_class'),
    });
  },
  
  hasPermission(roles, businessType) {
    return roles.some(role => 
      role.name === 'STORE_MANAGER' ||
      (businessType === 'personal_training' && role.name === 'PERSONAL_TRAINER') ||
      (businessType === 'group_class' && role.name === 'GROUP_FITNESS_INSTRUCTOR')
    );
  },
});
```

## 5. å®æ–½è·¯çº¿å›¾

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“ç»“æ„ä¼˜åŒ– (1-2å‘¨)
1. **Coachå®ä½“æ‰©å±•**
   - æ·»åŠ specializationTypeå­—æ®µ
   - æ·»åŠ businessSettingsé…ç½®
   - åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬

2. **è§’è‰²æƒé™ç»†åŒ–**
   - æ–°å¢PERSONAL_TRAINERå’ŒGROUP_FITNESS_INSTRUCTORè§’è‰²
   - ç»†åŒ–æƒé™å®šä¹‰
   - æ›´æ–°ç§å­æ•°æ®

### é˜¶æ®µäºŒï¼šåç«¯APIä¼˜åŒ– (2-3å‘¨)
1. **æ•™ç»ƒç®¡ç†æœåŠ¡æ‰©å±•**
   - å®ç°æŒ‰ä¸“ä¸šç±»å‹æŸ¥è¯¢
   - æ·»åŠ ä¸“ä¸šç±»å‹åˆ†é…åŠŸèƒ½
   - æƒé™æ§åˆ¶ä¸­é—´ä»¶

2. **ä¸šåŠ¡æµç¨‹ä¼˜åŒ–**
   - ç§æ•™é¢„çº¦æµç¨‹ä¼˜åŒ–
   - å›¢è¯¾æ’æœŸç®¡ç†ä¼˜åŒ–
   - å¡åˆ¸ä½¿ç”¨æƒé™æ§åˆ¶

### é˜¶æ®µä¸‰ï¼šå‰ç«¯ç•Œé¢é€‚é… (2-3å‘¨)
1. **ç®¡ç†ç³»ç»Ÿä¼˜åŒ–**
   - æ•™ç»ƒç®¡ç†ç•Œé¢é‡æ„
   - æƒé™æ§åˆ¶ç•Œé¢ä¼˜åŒ–
   - ä¸šåŠ¡æ•°æ®ç»Ÿè®¡åˆ†ç¦»

2. **å°ç¨‹åºç«¯ä¼˜åŒ–**
   - ä¼šå‘˜ç«¯æ•™ç»ƒé€‰æ‹©ä¼˜åŒ–
   - é—¨åº—ç«¯æƒé™æ§åˆ¶
   - ä¸šåŠ¡æµç¨‹ç•Œé¢åˆ†ç¦»

### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸éƒ¨ç½² (1-2å‘¨)
1. **åŠŸèƒ½æµ‹è¯•**
   - è§’è‰²æƒé™æµ‹è¯•
   - ä¸šåŠ¡æµç¨‹æµ‹è¯•
   - æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥è°ƒæ•´
   - æ¥å£æ€§èƒ½æµ‹è¯•

## 6. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 6.1 æŠ€æœ¯é£é™©
- **æ•°æ®è¿ç§»é£é™©**ï¼šç°æœ‰æ•°æ®çš„å…¼å®¹æ€§å¤„ç†
- **æƒé™æ§åˆ¶å¤æ‚åº¦**ï¼šç»†ç²’åº¦æƒé™å¯èƒ½å½±å“æ€§èƒ½
- **ä¸šåŠ¡é€»è¾‘å˜æ›´**ï¼šç°æœ‰ä¸šåŠ¡æµç¨‹çš„å‘åå…¼å®¹

### 6.2 åº”å¯¹ç­–ç•¥
- **æ¸è¿›å¼è¿ç§»**ï¼šåˆ†æ‰¹æ¬¡è¿›è¡Œæ•°æ®å’ŒåŠŸèƒ½è¿ç§»
- **æƒé™ç¼“å­˜**ï¼šå®ç°æƒé™ç»“æœç¼“å­˜æœºåˆ¶
- **ç‰ˆæœ¬å…¼å®¹**ï¼šä¿æŒAPIå‘åå…¼å®¹æ€§

## 7. é¢„æœŸæ”¶ç›Š

### 7.1 ä¸šåŠ¡æ”¶ç›Š
- **ä¸“ä¸šåŒ–æœåŠ¡**ï¼šæ•™ç»ƒä¸“ä¸šåˆ†å·¥æå‡æœåŠ¡è´¨é‡
- **è¿è¥æ•ˆç‡**ï¼šç²¾ç»†åŒ–æƒé™æ§åˆ¶æå‡ç®¡ç†æ•ˆç‡
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ¸…æ™°çš„ä¸šåŠ¡æµç¨‹æå‡ç”¨æˆ·æ»¡æ„åº¦

### 7.2 æŠ€æœ¯æ”¶ç›Š
- **ç³»ç»Ÿå¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„è§’è‰²èŒè´£è¾¹ç•Œ
- **æ‰©å±•æ€§**ï¼šçµæ´»çš„æƒé™ç³»ç»Ÿæ”¯æŒä¸šåŠ¡æ‰©å±•
- **æ•°æ®å®‰å…¨æ€§**ï¼šç»†ç²’åº¦æƒé™æ§åˆ¶ä¿éšœæ•°æ®å®‰å…¨

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ  
**ç»´æŠ¤äººå‘˜**ï¼šå¼€å‘å›¢é˜Ÿ  
**æ›´æ–°å‘¨æœŸ**ï¼šæ¯æœˆæ›´æ–°