# 电话销售管理系统数据库设计文档

## 一、数据库概述

### 1.1 数据库基本信息
- **数据库名称**: `tscrm`
- **数据库版本**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **时区**: Asia/Shanghai

### 1.2 设计原则
- 遵循第三范式，减少数据冗余
- 使用软删除保护重要数据
- 合理设计索引提升查询性能
- 外键约束保证数据完整性
- 统一的时间戳字段命名

---

## 二、数据库表结构设计

### 2.1 用户表 (users)
存储系统所有用户信息，包括管理员、组长、销售员。

```sql
CREATE TABLE `users` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `phone` varchar(11) NOT NULL COMMENT '手机号(登录账号)',
  `password` varchar(255) NOT NULL COMMENT '密码(bcrypt加密)',
  `name` varchar(50) NOT NULL COMMENT '用户姓名',
  `role` enum('admin','manager','leader','sales') NOT NULL COMMENT '用户角色',
  `team_id` int DEFAULT NULL COMMENT '所属小组ID',
  `join_date` date NOT NULL COMMENT '入职时间',
  `status` enum('active','inactive') DEFAULT 'active' COMMENT '用户状态',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间(软删除)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_phone` (`phone`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`),
  KEY `idx_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

**字段说明:**
- `id`: 主键，自增
- `phone`: 手机号，唯一索引，用作登录账号
- `password`: 密码，使用bcrypt加密存储
- `role`: 角色枚举，admin(系统管理员)/manager(总经理)/leader(组长)/sales(销售员)
- `team_id`: 外键，关联teams表
- `status`: 用户状态，active(激活)/inactive(停用)
- `deleted_at`: 软删除时间戳

### 2.2 小组表 (teams)
存储销售小组信息。

```sql
CREATE TABLE `teams` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '小组ID',
  `name` varchar(100) NOT NULL COMMENT '小组名称',
  `level` enum('4','10','15','30') NOT NULL COMMENT '小组等级(人数限制)',
  `leader_id` int DEFAULT NULL COMMENT '组长ID',
  `member_count` int DEFAULT 0 COMMENT '当前成员数量',
  `max_members` int NOT NULL COMMENT '最大成员数量',
  `description` text COMMENT '小组描述',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间(软删除)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`),
  KEY `idx_leader_id` (`leader_id`),
  KEY `idx_level` (`level`),
  KEY `idx_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='小组表';
```

**字段说明:**
- `level`: 小组等级，对应最大成员数量限制
- `member_count`: 当前成员数量，通过触发器自动维护
- `max_members`: 根据level自动设置的最大成员数

### 2.3 客户表 (customers)
存储客户基本信息。

```sql
CREATE TABLE `customers` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '客户ID',
  `star_level` tinyint NOT NULL COMMENT '价值星级(1-5)',
  `name` varchar(50) NOT NULL COMMENT '客户姓名',
  `phone` varchar(20) NOT NULL COMMENT '客户电话',
  `gender` enum('male','female') DEFAULT NULL COMMENT '性别',
  `age` tinyint DEFAULT NULL COMMENT '年龄',
  `qualification` text COMMENT '客户资质描述',
  `owner_id` int NOT NULL COMMENT '归属销售员ID',
  `team_id` int NOT NULL COMMENT '归属小组ID',
  `last_follow_time` timestamp NULL DEFAULT NULL COMMENT '最后跟进时间',
  `follow_count` int DEFAULT 0 COMMENT '总跟进次数',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间(软删除)',
  PRIMARY KEY (`id`),
  KEY `idx_phone` (`phone`),
  KEY `idx_owner_id` (`owner_id`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_star_level` (`star_level`),
  KEY `idx_last_follow_time` (`last_follow_time`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_deleted_at` (`deleted_at`),
  KEY `idx_owner_star` (`owner_id`, `star_level`),
  KEY `idx_team_star` (`team_id`, `star_level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='客户表';
```

**字段说明:**
- `star_level`: 客户价值星级，1-5星
- `last_follow_time`: 最后跟进时间，用于快速查询
- `follow_count`: 总跟进次数，通过触发器维护

### 2.4 跟进记录表 (follow_records)
存储客户跟进记录。

```sql
CREATE TABLE `follow_records` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '跟进记录ID',
  `customer_id` int NOT NULL COMMENT '客户ID',
  `sales_id` int NOT NULL COMMENT '跟进销售员ID',
  `content` text NOT NULL COMMENT '跟进内容',
  `follow_time` timestamp NOT NULL COMMENT '跟进时间',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_sales_id` (`sales_id`),
  KEY `idx_follow_time` (`follow_time`),
  KEY `idx_customer_follow_time` (`customer_id`, `follow_time` DESC),
  KEY `idx_sales_follow_time` (`sales_id`, `follow_time` DESC),
  KEY `idx_follow_date` ((DATE(`follow_time`)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='跟进记录表';
```

**字段说明:**
- `follow_time`: 跟进时间，可以由用户指定或使用当前时间
- `idx_follow_date`: 函数索引，用于按日期统计跟进数据

### 2.5 操作日志表 (operation_logs)
记录系统重要操作日志。

```sql
CREATE TABLE `operation_logs` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` int NOT NULL COMMENT '操作用户ID',
  `action` varchar(50) NOT NULL COMMENT '操作类型',
  `target_type` varchar(20) NOT NULL COMMENT '目标类型',
  `target_id` int NOT NULL COMMENT '目标ID',
  `details` json DEFAULT NULL COMMENT '操作详情(JSON格式)',
  `ip_address` varchar(45) DEFAULT NULL COMMENT '操作IP地址',
  `user_agent` text COMMENT '用户代理',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_action` (`action`),
  KEY `idx_target` (`target_type`, `target_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

**字段说明:**
- `action`: 操作类型，如CREATE_USER, UPDATE_CUSTOMER等
- `target_type`: 目标类型，如user, customer, team等
- `details`: JSON格式存储操作详情

---

## 三、外键约束设计

```sql
-- 用户表外键约束
ALTER TABLE `users` 
ADD CONSTRAINT `fk_users_team_id` 
FOREIGN KEY (`team_id`) REFERENCES `teams` (`id`) 
ON DELETE SET NULL ON UPDATE CASCADE;

-- 小组表外键约束
ALTER TABLE `teams` 
ADD CONSTRAINT `fk_teams_leader_id` 
FOREIGN KEY (`leader_id`) REFERENCES `users` (`id`) 
ON DELETE SET NULL ON UPDATE CASCADE;

-- 客户表外键约束
ALTER TABLE `customers` 
ADD CONSTRAINT `fk_customers_owner_id` 
FOREIGN KEY (`owner_id`) REFERENCES `users` (`id`) 
ON DELETE RESTRICT ON UPDATE CASCADE;

ALTER TABLE `customers` 
ADD CONSTRAINT `fk_customers_team_id` 
FOREIGN KEY (`team_id`) REFERENCES `teams` (`id`) 
ON DELETE RESTRICT ON UPDATE CASCADE;

-- 跟进记录表外键约束
ALTER TABLE `follow_records` 
ADD CONSTRAINT `fk_follow_records_customer_id` 
FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) 
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE `follow_records` 
ADD CONSTRAINT `fk_follow_records_sales_id` 
FOREIGN KEY (`sales_id`) REFERENCES `users` (`id`) 
ON DELETE RESTRICT ON UPDATE CASCADE;

-- 操作日志表外键约束
ALTER TABLE `operation_logs` 
ADD CONSTRAINT `fk_operation_logs_user_id` 
FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) 
ON DELETE RESTRICT ON UPDATE CASCADE;
```

---

## 四、触发器设计

### 4.1 维护小组成员数量触发器

```sql
-- 用户加入小组时增加成员数量
DELIMITER $$
CREATE TRIGGER `tr_users_team_insert` 
AFTER INSERT ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.team_id IS NOT NULL THEN
        UPDATE teams SET member_count = member_count + 1 
        WHERE id = NEW.team_id;
    END IF;
END$$

-- 用户更新小组时调整成员数量
CREATE TRIGGER `tr_users_team_update` 
AFTER UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    IF OLD.team_id != NEW.team_id THEN
        -- 从原小组减少
        IF OLD.team_id IS NOT NULL THEN
            UPDATE teams SET member_count = member_count - 1 
            WHERE id = OLD.team_id;
        END IF;
        -- 向新小组增加
        IF NEW.team_id IS NOT NULL THEN
            UPDATE teams SET member_count = member_count + 1 
            WHERE id = NEW.team_id;
        END IF;
    END IF;
END$$

-- 用户删除时减少成员数量
CREATE TRIGGER `tr_users_team_delete` 
AFTER UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.deleted_at IS NOT NULL AND OLD.deleted_at IS NULL THEN
        IF NEW.team_id IS NOT NULL THEN
            UPDATE teams SET member_count = member_count - 1 
            WHERE id = NEW.team_id;
        END IF;
    END IF;
END$$
DELIMITER ;
```

### 4.2 维护客户跟进统计触发器

```sql
-- 新增跟进记录时更新客户统计
DELIMITER $$
CREATE TRIGGER `tr_follow_records_insert` 
AFTER INSERT ON `follow_records` 
FOR EACH ROW 
BEGIN
    UPDATE customers 
    SET last_follow_time = NEW.follow_time,
        follow_count = follow_count + 1
    WHERE id = NEW.customer_id;
END$$

-- 删除跟进记录时更新客户统计
CREATE TRIGGER `tr_follow_records_delete` 
AFTER DELETE ON `follow_records` 
FOR EACH ROW 
BEGIN
    UPDATE customers 
    SET follow_count = follow_count - 1,
        last_follow_time = (
            SELECT MAX(follow_time) 
            FROM follow_records 
            WHERE customer_id = OLD.customer_id
        )
    WHERE id = OLD.customer_id;
END$$
DELIMITER ;
```

---

## 五、视图设计

### 5.1 客户跟进统计视图

```sql
-- 每日客户跟进统计视图
CREATE VIEW `v_daily_follow_stats` AS
SELECT 
    DATE(fr.follow_time) as follow_date,
    u.id as sales_id,
    u.name as sales_name,
    u.team_id,
    t.name as team_name,
    COUNT(DISTINCT fr.customer_id) as follow_customer_count,
    COUNT(fr.id) as follow_record_count
FROM follow_records fr
JOIN users u ON fr.sales_id = u.id
LEFT JOIN teams t ON u.team_id = t.id
WHERE u.deleted_at IS NULL
GROUP BY DATE(fr.follow_time), u.id;

-- 客户详情视图(包含最新跟进信息)
CREATE VIEW `v_customer_details` AS
SELECT 
    c.*,
    u.name as owner_name,
    u.phone as owner_phone,
    t.name as team_name,
    (SELECT COUNT(*) FROM follow_records fr 
     WHERE fr.customer_id = c.id 
     AND DATE(fr.follow_time) = CURDATE()) as today_follow_count,
    (SELECT content FROM follow_records fr 
     WHERE fr.customer_id = c.id 
     ORDER BY fr.follow_time DESC LIMIT 1) as last_follow_content
FROM customers c
JOIN users u ON c.owner_id = u.id
JOIN teams t ON c.team_id = t.id
WHERE c.deleted_at IS NULL 
AND u.deleted_at IS NULL;
```

---

## 六、索引优化策略

### 6.1 复合索引设计

```sql
-- 客户表复合索引
ALTER TABLE customers ADD INDEX idx_owner_star (owner_id, star_level);
ALTER TABLE customers ADD INDEX idx_team_star (team_id, star_level);
ALTER TABLE customers ADD INDEX idx_owner_follow (owner_id, last_follow_time);

-- 跟进记录表复合索引
ALTER TABLE follow_records ADD INDEX idx_customer_follow_time (customer_id, follow_time DESC);
ALTER TABLE follow_records ADD INDEX idx_sales_follow_time (sales_id, follow_time DESC);

-- 操作日志表复合索引
ALTER TABLE operation_logs ADD INDEX idx_user_action_time (user_id, action, created_at);
```

### 6.2 函数索引(MySQL 8.0+)

```sql
-- 按跟进日期的函数索引
ALTER TABLE follow_records ADD INDEX idx_follow_date ((DATE(follow_time)));

-- 按创建日期的函数索引
ALTER TABLE customers ADD INDEX idx_create_date ((DATE(created_at)));
```

---

## 七、数据库初始化脚本

### 7.1 创建数据库

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS `tscrm` 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE `tscrm`;

-- 设置时区
SET time_zone = '+08:00';
```

### 7.2 初始数据插入

```sql
-- 插入默认管理员账号
INSERT INTO `users` (`phone`, `password`, `name`, `role`, `join_date`) VALUES 
('13800000000', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.PmvlG.', '系统管理员', 'manager', CURDATE());

-- 插入示例小组
INSERT INTO `teams` (`name`, `level`, `max_members`) VALUES 
('销售一组', '10', 10),
('销售二组', '15', 15),
('销售三组', '30', 30);

-- 更新小组组长
UPDATE `teams` SET `leader_id` = 1 WHERE `name` = '销售一组';

-- 插入示例销售员
INSERT INTO `users` (`phone`, `password`, `name`, `role`, `team_id`, `join_date`) VALUES 
('13800000001', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.PmvlG.', '组长张三', 'leader', 1, CURDATE()),
('13800000002', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.PmvlG.', '销售员李四', 'sales', 1, CURDATE()),
('13800000003', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.PmvlG.', '销售员王五', 'sales', 1, CURDATE());

-- 插入示例客户
INSERT INTO `customers` (`star_level`, `name`, `phone`, `gender`, `age`, `qualification`, `owner_id`, `team_id`) VALUES 
(5, '客户张三', '13900000001', 'male', 35, '高净值客户', 3, 1),
(4, '客户李四', '13900000002', 'female', 28, '潜在客户', 3, 1),
(3, '客户王五', '13900000003', 'male', 42, '普通客户', 4, 1);

-- 插入示例跟进记录
INSERT INTO `follow_records` (`customer_id`, `sales_id`, `content`, `follow_time`) VALUES 
(1, 3, '初次联系，客户有购买意向', NOW() - INTERVAL 1 DAY),
(1, 3, '发送产品资料，客户表示满意', NOW() - INTERVAL 2 HOUR),
(2, 3, '电话回访，了解客户需求', NOW() - INTERVAL 3 HOUR),
(3, 4, '客户咨询价格，正在考虑中', NOW() - INTERVAL 1 HOUR);
```

---

## 八、数据库维护

### 8.1 定期清理策略

```sql
-- 清理6个月前的操作日志
DELETE FROM operation_logs 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- 清理已删除用户的相关数据(谨慎操作)
-- DELETE FROM users WHERE deleted_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### 8.2 数据备份策略

```bash
#!/bin/bash
# 每日备份脚本
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="tscrm"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 全量备份
mysqldump -u root -p$MYSQL_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  $DB_NAME > $BACKUP_DIR/tscrm_full_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/tscrm_full_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "tscrm_full_*.sql.gz" -mtime +7 -delete
```

### 8.3 性能监控查询

```sql
-- 查看慢查询
SELECT * FROM mysql.slow_log 
WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC;

-- 查看表大小
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'tscrm'
ORDER BY (data_length + index_length) DESC;

-- 查看索引使用情况
SELECT 
    table_name,
    index_name,
    cardinality,
    non_unique
FROM information_schema.statistics 
WHERE table_schema = 'tscrm'
ORDER BY table_name, cardinality DESC;
```

---

## 九、数据库ER图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     teams       │       │     users       │       │   customers     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──────┤ team_id (FK)    │       │ id (PK)         │
│ name            │       │ id (PK)         │──────►│ owner_id (FK)   │
│ level           │   ┌───┤ phone (UK)      │       │ team_id (FK)    │
│ leader_id (FK)  │───┘   │ password        │       │ star_level      │
│ member_count    │       │ name            │       │ name            │
│ max_members     │       │ role            │       │ phone           │
│ created_at      │       │ join_date       │       │ gender          │
│ updated_at      │       │ status          │       │ age             │
│ deleted_at      │       │ created_at      │       │ qualification   │
└─────────────────┘       │ updated_at      │       │ last_follow_time│
                          │ deleted_at      │       │ follow_count    │
                          └─────────────────┘       │ created_at      │
                                    │               │ updated_at      │
                                    │               │ deleted_at      │
                                    │               └─────────────────┘
                                    │                         │
                                    │                         │
                                    ▼                         ▼
                          ┌─────────────────┐       ┌─────────────────┐
                          │ operation_logs  │       │ follow_records  │
                          ├─────────────────┤       ├─────────────────┤
                          │ id (PK)         │       │ id (PK)         │
                          │ user_id (FK)    │       │ customer_id (FK)│
                          │ action          │       │ sales_id (FK)   │
                          │ target_type     │       │ content         │
                          │ target_id       │       │ follow_time     │
                          │ details (JSON)  │       │ created_at      │
                          │ ip_address      │       └─────────────────┘
                          │ user_agent      │
                          │ created_at      │
                          └─────────────────┘
```

**关系说明:**
- users.team_id → teams.id (多对一)
- teams.leader_id → users.id (一对一)
- customers.owner_id → users.id (多对一)
- customers.team_id → teams.id (多对一)
- follow_records.customer_id → customers.id (多对一)
- follow_records.sales_id → users.id (多对一)
- operation_logs.user_id → users.id (多对一)

---

## 十、数据库配置优化

### 10.1 MySQL配置建议

```ini
# my.cnf 配置建议
[mysqld]
# 基础配置
default-storage-engine = InnoDB
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 内存配置
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_log_buffer_size = 16M

# 连接配置
max_connections = 200
max_connect_errors = 1000

# 查询缓存
query_cache_type = 1
query_cache_size = 128M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# 二进制日志
log-bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7

# 时区设置
default-time-zone = '+08:00'
```

### 10.2 性能优化建议

1. **定期分析表统计信息**
```sql
ANALYZE TABLE users, teams, customers, follow_records, operation_logs;
```

2. **定期优化表**
```sql
OPTIMIZE TABLE users, teams, customers, follow_records, operation_logs;
```

3. **监控关键指标**
- 查询响应时间
- 索引命中率
- 缓冲池命中率
- 慢查询数量

---

这份数据库设计文档提供了完整的表结构、索引、约束和优化策略，为系统的稳定运行提供了坚实的数据基础。建议在开发过程中严格按照此设计执行，并根据实际使用情况进行适当调整。 