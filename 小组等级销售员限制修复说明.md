# 小组等级销售员限制修复说明

## 问题描述

原来的小组等级限制逻辑存在问题：小组等级对应的人员数量限制计算的是所有成员（包括组长和销售员），但根据业务需求，应该只计算销售员的数量，组长不应该计入小组等级限制。

## 修复内容

### 1. 修改团队成员添加逻辑

**文件**: `backend/src/routes/teams-sqlite.js`

**修改内容**:
- 在添加成员到团队时，如果是销售员，只检查销售员数量是否超过小组等级限制
- 组长可以正常添加，不受小组等级限制影响
- 更新团队成员数量计算方式，使用重新计算而非增减操作

**修改前**:
```javascript
// 检查团队是否已满
if (team.member_count >= team.max_members) {
  return res.status(400).json({
    code: 400,
    message: '团队已满，无法添加更多成员',
    timestamp: Date.now()
  });
}
```

**修改后**:
```javascript
// 如果要添加的是销售员，检查销售员数量是否已满
if (user.role === 'sales') {
  // 计算当前团队中销售员的数量
  const salesCount = await query(
    'SELECT COUNT(*) as count FROM users WHERE team_id = ? AND role = "sales" AND deleted_at IS NULL',
    [teamId]
  );
  
  if (salesCount[0].count >= team.max_members) {
    return res.status(400).json({
      code: 400,
      message: `团队销售员已满，最多可容纳${team.max_members}名销售员`,
      timestamp: Date.now()
    });
  }
}
```

### 2. 修改用户创建和更新逻辑

**文件**: `backend/src/routes/users-sqlite.js`

**修改内容**:
- 在创建用户时，如果是销售员角色，检查目标团队的销售员数量限制
- 在更新用户团队时，同样只对销售员进行数量限制检查
- 优化团队成员数量更新逻辑，使用重新计算确保数据准确性

### 3. 修改批量操作逻辑

**文件**: `backend/src/routes/users-sqlite.js`

**修改内容**:
- 批量更新用户团队时，只计算销售员数量是否超过限制
- 批量删除用户时，重新计算团队成员数量

### 4. 创建数据修复脚本

**文件**: `backend/fix-team-sales-limit.js`

**功能**:
- 检查所有团队的销售员数量是否超过小组等级限制
- 自动移除超出限制的销售员（按入职时间倒序移除）
- 重新计算所有团队的成员数量
- 显示修复后的状态和未分配团队的用户

## 业务逻辑说明

### 小组等级限制规则

| 小组等级 | 最大销售员数量 | 组长数量 | 说明 |
|---------|---------------|----------|------|
| 4人组   | 4名销售员     | 1名组长  | 组长不计入4人限制 |
| 10人组  | 10名销售员    | 1名组长  | 组长不计入10人限制 |
| 15人组  | 15名销售员    | 1名组长  | 组长不计入15人限制 |
| 30人组  | 30名销售员    | 1名组长  | 组长不计入30人限制 |

### 权限控制

1. **销售员添加限制**: 当团队中销售员数量达到小组等级限制时，无法再添加新的销售员
2. **组长添加限制**: 每个团队只能有一个组长，但组长不受小组等级限制影响
3. **成员转移**: 转移销售员到其他团队时，需要检查目标团队的销售员数量限制

## 修复结果

运行修复脚本后的状态：

```
📊 修复后的团队状态:
- 华东销售组7091: 2/10销售员, 1组长, 总3人 🟢 正常
- 华南销售组8812: 3/15销售员, 0组长, 总3人 🟢 正常
- 测试小组: 3/4销售员, 1组长, 总4人 🟢 正常
```

所有团队的销售员数量都在限制范围内，修复成功。

## 影响范围

1. **前端界面**: 团队管理页面的成员数量显示逻辑保持不变，仍显示总成员数
2. **API接口**: 添加成员、创建用户、更新用户等接口的验证逻辑已更新
3. **数据库**: 团队成员数量字段(`member_count`)仍记录总成员数，但限制检查只针对销售员
4. **统计功能**: 统计页面的数据显示不受影响

## 测试建议

1. 测试添加销售员到已满的团队（应该被拒绝）
2. 测试添加组长到已有组长的团队（应该被拒绝）
3. 测试添加组长到销售员已满的团队（应该成功）
4. 测试批量转移销售员到已满的团队（应该被拒绝）
5. 验证团队成员数量统计的准确性

## 注意事项

1. 这次修改是向后兼容的，不会影响现有数据的完整性
2. 团队的`member_count`字段仍然记录总成员数（包括组长和销售员）
3. 小组等级限制只在添加销售员时生效，不影响组长的添加
4. 建议在生产环境部署前先运行修复脚本确保数据一致性 